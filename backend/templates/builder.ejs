<!-- DevOpser Lite Website Builder Template -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= site ? site.name + ' - DevOpser Builder' : 'DevOpser Lite' %></title>
  <link rel="icon" href="/static/icon.png" type="image/png">

  <!-- CSS Files -->
  <link rel="stylesheet" href="/static/css/litera-bootstrap.min.css">
  <link rel="stylesheet" href="/static/css/bootstrap-icons.css">
  <link rel="stylesheet" href="/static/nav.css">

  <!-- Builder-specific styles -->
  <style nonce="<%= cspNonce %>">
    :root {
      --sidebar-width: 350px;
      --preview-bg: #f8f9fa;
      --primary-color: #3B82F6;
      --secondary-color: #10B981;
    }

    /* Status icon - small dot */
    .status-icon-dot {
      font-size: 0.5rem;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    .builder-container {
      display: flex;
      height: calc(100vh - 56px);
    }

    /* Chat Sidebar */
    .chat-sidebar {
      width: var(--sidebar-width);
      min-width: var(--sidebar-width);
      background: #fff;
      border-right: 1px solid #dee2e6;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      padding: 1rem;
      border-bottom: 1px solid #dee2e6;
      background: #f8f9fa;
    }

    .chat-header h5 {
      margin: 0;
      font-weight: 600;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .chat-message {
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      max-width: 90%;
    }

    .chat-message.user {
      background: #0d6efd;
      color: white;
      margin-left: auto;
    }

    .chat-message.assistant {
      background: #e9ecef;
      color: #212529;
    }

    .chat-message.system {
      background: #fff3cd;
      color: #856404;
      font-size: 0.875rem;
      text-align: center;
      max-width: 100%;
    }

    .chat-message.tools-used {
      background: #d1e7dd;
      color: #0f5132;
      font-size: 0.75rem;
      text-align: center;
      max-width: 100%;
      padding: 0.5rem;
    }

    .chat-input-container {
      padding: 1rem;
      border-top: 1px solid #dee2e6;
      background: #f8f9fa;
    }

    .chat-input-container textarea {
      width: 100%;
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      padding: 0.75rem;
      resize: none;
      font-size: 0.95rem;
    }

    .chat-input-container textarea:focus {
      outline: none;
      border-color: #0d6efd;
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
    }

    .chat-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    /* Preview Area */
    .preview-area {
      flex: 1;
      background: var(--preview-bg);
      display: flex;
      flex-direction: column;
    }

    .preview-header {
      padding: 0.75rem 1rem;
      background: #fff;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .preview-url {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: #f8f9fa;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-family: monospace;
      font-size: 0.875rem;
      color: #6c757d;
    }

    .preview-actions {
      display: flex;
      gap: 0.5rem;
    }

    .preview-frame-container {
      flex: 1;
      padding: 1rem;
      overflow: hidden;
    }

    .preview-frame {
      width: 100%;
      height: 100%;
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      overflow: auto;
    }

    /* Site Preview Renderer */
    .site-preview {
      font-family: 'Inter', system-ui, sans-serif;
    }

    .section-hero {
      padding: 4rem 2rem;
      text-align: center;
      background: linear-gradient(135deg, var(--primary-color, #3B82F6), var(--secondary-color, #8B5CF6));
      color: white;
    }

    .section-hero h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }

    .section-hero p {
      font-size: 1.25rem;
      opacity: 0.9;
      margin-bottom: 2rem;
    }

    .section-hero .cta-btn {
      background: white;
      color: var(--primary-color, #3B82F6);
      padding: 0.75rem 2rem;
      border-radius: 0.5rem;
      font-weight: 600;
      text-decoration: none;
      display: inline-block;
    }

    .section-hero .cta-btn-white {
      background: white;
      color: #1a1a1a;
    }

    .section-hero.dark-bg h1,
    .section-hero.dark-bg p {
      color: white;
    }

    /* WYSIWYG Editable Elements */
    [data-editable] {
      cursor: pointer;
      transition: outline 0.2s, background 0.2s;
      border-radius: 4px;
    }

    [data-editable]:hover {
      outline: 2px dashed rgba(13, 110, 253, 0.5);
      outline-offset: 4px;
    }

    [data-editable]:focus {
      outline: 2px solid #0d6efd;
      outline-offset: 4px;
      background: rgba(255, 255, 255, 0.1);
    }

    [data-editable][contenteditable="true"] {
      cursor: text;
    }

    /* Edit hint tooltip */
    [data-editable]::after {
      content: 'Click to edit';
      position: absolute;
      top: -24px;
      left: 50%;
      transform: translateX(-50%);
      background: #0d6efd;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      white-space: nowrap;
    }

    [data-editable]:hover::after {
      opacity: 1;
    }

    [data-editable]:focus::after {
      content: 'Press Enter to save, Esc to cancel';
    }

    /* Make editable elements position relative for tooltip */
    .section-hero h1,
    .section-hero p,
    .section-features h2,
    .feature-item h3,
    .feature-item p,
    .section-about h2,
    .section-about p,
    .section-contact h2,
    .section-contact p,
    .cta-btn {
      position: relative;
    }

    /* Link edit popup */
    .link-edit-popup {
      position: fixed;
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      display: none;
    }

    .link-edit-popup.active {
      display: block;
    }

    .link-edit-popup input {
      width: 250px;
      padding: 8px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      font-size: 14px;
    }

    .link-edit-popup .btn-group {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }

    .link-edit-popup button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .link-edit-popup .btn-save {
      background: #0d6efd;
      color: white;
    }

    .link-edit-popup .btn-cancel {
      background: #6c757d;
      color: white;
    }

    .section-features {
      padding: 4rem 2rem;
      background: #fff;
    }

    .section-features h2 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 3rem;
    }

    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
      max-width: 1000px;
      margin: 0 auto;
    }

    .feature-item {
      text-align: center;
      padding: 1.5rem;
    }

    .feature-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: var(--primary-color, #3B82F6);
    }

    .feature-item h3 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }

    .feature-item p {
      color: #6c757d;
      font-size: 0.95rem;
    }

    .section-about {
      padding: 4rem 2rem;
      background: #f8f9fa;
    }

    .section-contact {
      padding: 4rem 2rem;
      background: #fff;
    }

    .section-footer {
      padding: 2rem;
      background: #212529;
      color: white;
      text-align: center;
    }

    /* Status badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-draft { background: #ffc107; color: #212529; }
    .status-deploying { background: #17a2b8; color: white; }
    .status-published { background: #28a745; color: white; }
    .status-failed { background: #dc3545; color: white; }

    /* Empty state */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #6c757d;
      text-align: center;
      padding: 2rem;
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .loading-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #6c757d;
    }

    .loading-indicator .spinner-border {
      width: 1rem;
      height: 1rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .builder-container {
        flex-direction: column;
      }

      .chat-sidebar {
        width: 100%;
        height: 50%;
      }

      .preview-area {
        height: 50%;
      }
    }
  </style>

  <script src="/static/js/bootstrap.bundle.min.js" defer></script>
</head>
<body>
  <header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="/sites">DevOpser Lite</a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="/sites">My Sites</a>
            </li>
          </ul>
          <ul class="navbar-nav">
            <% if (site) { %>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="status-badge status-<%= site.status %>">
                  <i class="bi bi-circle-fill status-icon-dot"></i>
                  <%= site.status.charAt(0).toUpperCase() + site.status.slice(1) %>
                </span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><h6 class="dropdown-header">Site Status</h6></li>
                <li><span class="dropdown-item-text small text-muted"><%= site.slug %>.devopser.io</span></li>
                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header text-danger">Danger Zone</h6></li>
                <li>
                  <button class="dropdown-item text-danger" id="delete-site-btn">
                    <i class="bi bi-trash me-2"></i>Delete Site
                  </button>
                </li>
              </ul>
            </li>
            <% } %>
            <li class="nav-item">
              <a class="nav-link" href="/account">Account</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/auth/logout">Logout</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <main class="builder-container">
    <!-- Chat Sidebar -->
    <div class="chat-sidebar">
      <div class="chat-header">
        <h5><i class="bi bi-chat-dots me-2"></i>Build with AI</h5>
        <% if (site) { %>
        <small class="text-muted"><%= site.name %></small>
        <% } %>
      </div>

      <div class="chat-messages" id="chat-messages">
        <% if (!site || !site.draftConfig || !site.draftConfig.sections || site.draftConfig.sections.length === 0) { %>
        <div class="chat-message system">
          <i class="bi bi-lightbulb me-1"></i>
          Describe your website and I'll create it for you! For example: "I want a landing page for a fitness app"
        </div>
        <% } else { %>
        <div class="chat-message system">
          <i class="bi bi-check-circle me-1"></i>
          Your site is ready! Ask me to make changes, like "make the headline more exciting" or "add a pricing section"
        </div>
        <% } %>
      </div>

      <div class="chat-input-container">
        <textarea
          id="chat-input"
          placeholder="Describe what you want..."
          rows="3"
        ></textarea>
        <div class="chat-actions">
          <button id="send-btn" class="btn btn-primary flex-grow-1">
            <i class="bi bi-send me-1"></i> Send
          </button>
          <% if (site && site.draftConfig && site.draftConfig.sections && site.draftConfig.sections.length > 0) { %>
          <button id="publish-btn" class="btn btn-success" <%= site.status === 'deploying' ? 'disabled' : '' %>>
            <i class="bi bi-rocket-takeoff me-1"></i> Publish
          </button>
          <% } %>
        </div>
      </div>

    </div>

    <!-- Preview Area -->
    <div class="preview-area">
      <div class="preview-header">
        <div class="preview-url">
          <i class="bi bi-globe"></i>
          <% if (site) { %>
          <span><%= site.slug %>.devopser.io</span>
          <% } else { %>
          <span>your-site.devopser.io</span>
          <% } %>
        </div>
        <div class="preview-actions">
          <button class="btn btn-outline-secondary btn-sm" id="refresh-preview">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
          <% if (site && site.status === 'published') { %>
          <a href="<%= site.publicUrl %>" target="_blank" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-box-arrow-up-right me-1"></i> View Live
          </a>
          <% } %>
        </div>
      </div>

      <div class="preview-frame-container">
        <div class="preview-frame" id="preview-frame">
          <% if (site && site.draftConfig && site.draftConfig.sections && site.draftConfig.sections.length > 0) { %>
          <!-- Render site preview -->
          <div class="site-preview" id="site-preview">
            <%
            const config = site.draftConfig;
            const primaryColor = config.theme?.primaryColor || '#3B82F6';
            const secondaryColor = config.theme?.secondaryColor || '#10B981';
            %>
            <style nonce="<%= cspNonce %>">
              .site-preview { --primary-color: <%= primaryColor %>; --secondary-color: <%= secondaryColor %>; }
            </style>

            <%
              // Helper to detect dark colors for text contrast
              function isColorDarkEJS(hexColor) {
                if (!hexColor || typeof hexColor !== 'string') return false;
                const hex = hexColor.replace('#', '');
                if (hex.length !== 6 && hex.length !== 3) return false;
                let r, g, b;
                if (hex.length === 3) {
                  r = parseInt(hex[0] + hex[0], 16);
                  g = parseInt(hex[1] + hex[1], 16);
                  b = parseInt(hex[2] + hex[2], 16);
                } else {
                  r = parseInt(hex.substring(0, 2), 16);
                  g = parseInt(hex.substring(2, 4), 16);
                  b = parseInt(hex.substring(4, 6), 16);
                }
                const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                return luminance < 0.5;
              }
            %>
            <% config.sections.filter(s => s.visible !== false).sort((a,b) => a.order - b.order).forEach(section => { %>
              <% if (section.type === 'hero') { %>
              <%
                const heroBgStart = section.content.backgroundColorStart || primaryColor;
                const heroBgEnd = section.content.backgroundColorEnd || secondaryColor;
                const hasCustomBg = section.content.backgroundColorStart || section.content.backgroundColorEnd;
                const isDarkBg = hasCustomBg && (isColorDarkEJS(heroBgStart) || isColorDarkEJS(heroBgEnd));
                const heroClass = isDarkBg ? 'section-hero dark-bg' : 'section-hero';
                const ctaBtnClass = isDarkBg ? 'cta-btn cta-btn-white' : 'cta-btn';
              %>
              <div class="<%= heroClass %>" data-section-id="<%= section.id %>" data-section-type="hero" data-bg-start="<%= heroBgStart %>" data-bg-end="<%= heroBgEnd %>">
                <h1 data-editable data-field="headline"><%= section.content.headline %></h1>
                <p data-editable data-field="subheadline"><%= section.content.subheadline %></p>
                <% if (section.content.ctaText) { %>
                <a href="<%= section.content.ctaLink || '#' %>" class="<%= ctaBtnClass %>" data-editable-link data-field="ctaText" data-link-field="ctaLink"><%= section.content.ctaText %></a>
                <% } %>
              </div>
              <% } else if (section.type === 'features') { %>
              <div class="section-features" data-section-id="<%= section.id %>" data-section-type="features">
                <h2 data-editable data-field="title"><%= section.content.title %></h2>
                <div class="features-grid">
                  <% (section.content.items || []).forEach((item, itemIndex) => { %>
                  <div class="feature-item" data-item-index="<%= itemIndex %>">
                    <div class="feature-icon"><i class="bi bi-<%= item.icon || 'star' %>"></i></div>
                    <h3 data-editable data-field="items.<%= itemIndex %>.title"><%= item.title %></h3>
                    <p data-editable data-field="items.<%= itemIndex %>.description"><%= item.description %></p>
                  </div>
                  <% }) %>
                </div>
              </div>
              <% } else if (section.type === 'about') { %>
              <div class="section-about" data-section-id="<%= section.id %>" data-section-type="about">
                <h2 data-editable data-field="title"><%= section.content.title %></h2>
                <p data-editable data-field="content"><%= section.content.content %></p>
              </div>
              <% } else if (section.type === 'contact') { %>
              <div class="section-contact" data-section-id="<%= section.id %>" data-section-type="contact">
                <h2 data-editable data-field="title"><%= section.content.title %></h2>
                <p data-editable data-field="subtitle"><%= section.content.subtitle %></p>
                <% if (section.content.email) { %>
                <p><i class="bi bi-envelope me-2"></i><span data-editable data-field="email"><%= section.content.email %></span></p>
                <% } %>
              </div>
              <% } else if (section.type === 'footer') { %>
              <div class="section-footer" data-section-id="<%= section.id %>" data-section-type="footer">
                <p data-editable data-field="copyright"><%= section.content.copyright || '© ' + new Date().getFullYear() + ' ' + (section.content.companyName || config.siteName) %></p>
              </div>
              <% } %>
            <% }) %>
          </div>
          <% } else { %>
          <div class="empty-state">
            <i class="bi bi-easel"></i>
            <h5>No preview yet</h5>
            <p>Describe your website in the chat to get started!</p>
          </div>
          <% } %>
        </div>
      </div>
    </div>
  </main>

  <!-- Link/Button Edit Popup -->
  <div class="link-edit-popup" id="linkEditPopup">
    <div style="margin-bottom: 8px; font-weight: 600; font-size: 13px;">Edit Button</div>
    <div style="margin-bottom: 8px;">
      <label style="font-size: 12px; color: #6c757d;">Button Text</label>
      <input type="text" id="linkEditText" placeholder="Button text">
    </div>
    <div style="margin-bottom: 8px;">
      <label style="font-size: 12px; color: #6c757d;">Link URL</label>
      <input type="text" id="linkEditUrl" placeholder="https://...">
    </div>
    <div class="btn-group">
      <button class="btn-save" onclick="saveLinkEdit()">Save</button>
      <button class="btn-cancel" onclick="closeLinkEdit()">Cancel</button>
    </div>
  </div>

  <script nonce="<%= cspNonce %>">
    // Site data from server
    const siteId = '<%= site ? site.id : "" %>';
    const siteData = <%- site ? JSON.stringify(site) : 'null' %>;

    // Chat functionality
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const publishBtn = document.getElementById('publish-btn');
    const previewFrame = document.getElementById('preview-frame');
    const refreshPreviewBtn = document.getElementById('refresh-preview');

    let chatHistory = [];
    let isProcessing = false;

    // Add message to chat
    function addMessage(role, content) {
      const div = document.createElement('div');
      div.className = `chat-message ${role}`;
      div.textContent = content;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Add tools used indicator
    function addToolsUsedMessage(toolNames) {
      const div = document.createElement('div');
      div.className = 'chat-message tools-used';
      div.innerHTML = '<i class="bi bi-tools me-1"></i> Used: ' + escapeHtml(toolNames);
      chatMessages.appendChild(div);
    }

    // Send chat message
    async function sendMessage() {
      const message = chatInput.value.trim();
      if (!message || isProcessing || !siteId) return;

      isProcessing = true;
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Processing...';

      // Add user message to chat
      addMessage('user', message);
      chatInput.value = '';

      // Add to history
      chatHistory.push({ role: 'user', content: message });

      try {
        const response = await fetch(`/api/sites/${siteId}/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'same-origin',
          body: JSON.stringify({
            message,
            history: chatHistory
          })
        });

        const data = await response.json();

        if (data.success) {
          // Show tools used if any
          if (data.toolsUsed && data.toolsUsed.length > 0) {
            const toolNames = data.toolsUsed.map(t => t.name.replace(/_/g, ' ')).join(', ');
            addToolsUsedMessage(toolNames);
          }

          // Add AI response to chat
          addMessage('assistant', data.message);
          chatHistory.push({ role: 'assistant', content: data.message });

          // Refresh preview if config changed
          if (data.siteConfig) {
            console.log('[Builder] Refreshing preview with config:', JSON.stringify(data.siteConfig.sections?.find(s => s.type === 'hero')?.content, null, 2));
            refreshPreview(data.siteConfig);
            // Update local siteData
            siteData.draftConfig = data.siteConfig;

            // Show publish button if we now have content
            if (data.siteConfig.sections && data.siteConfig.sections.length > 0) {
              if (!publishBtn) {
                location.reload(); // Reload to show publish button
              }
            }
          }
        } else {
          addMessage('system', 'Error: ' + (data.error || 'Something went wrong'));
        }
      } catch (error) {
        console.error('Chat error:', error);
        addMessage('system', 'Error: Failed to send message. Please try again.');
      }

      isProcessing = false;
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<i class="bi bi-send me-1"></i> Send';
    }

    // Helper to determine if a hex color is dark (for text contrast)
    function isColorDark(hexColor) {
      if (!hexColor || typeof hexColor !== 'string') return false;
      var hex = hexColor.replace('#', '');
      if (hex.length !== 6 && hex.length !== 3) return false;
      var r, g, b;
      if (hex.length === 3) {
        r = parseInt(hex[0] + hex[0], 16);
        g = parseInt(hex[1] + hex[1], 16);
        b = parseInt(hex[2] + hex[2], 16);
      } else {
        r = parseInt(hex.substring(0, 2), 16);
        g = parseInt(hex.substring(2, 4), 16);
        b = parseInt(hex.substring(4, 6), 16);
      }
      var luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      return luminance < 0.5;
    }

    // Refresh preview with new config
    function refreshPreview(config) {
      console.log('[Builder] refreshPreview called');
      const primaryColor = config.theme?.primaryColor || '#3B82F6';
      const secondaryColor = config.theme?.secondaryColor || '#10B981';

      let html = '<div class="site-preview" id="sitePreviewContent">';

      const sections = (config.sections || [])
        .filter(s => s.visible !== false)
        .sort((a, b) => a.order - b.order);

      sections.forEach(function(section, sectionIndex) {
        var sectionId = section.id;
        if (section.type === 'hero') {
          // Support custom hero background colors
          var heroBgStart = section.content.backgroundColorStart || primaryColor;
          var heroBgEnd = section.content.backgroundColorEnd || secondaryColor;
          var hasCustomBg = section.content.backgroundColorStart || section.content.backgroundColorEnd;
          var isDark = hasCustomBg && (isColorDark(heroBgStart) || isColorDark(heroBgEnd));
          var heroClass = isDark ? 'section-hero dark-bg' : 'section-hero';
          console.log('[Builder] Hero rendering:', { heroBgStart, heroBgEnd, hasCustomBg, isDark });
          // Use data attributes for colors and editing - CSS will be applied via JS after innerHTML
          html += '<div class="' + heroClass + '" data-section-id="' + sectionId + '" data-section-type="hero" data-bg-start="' + heroBgStart + '" data-bg-end="' + heroBgEnd + '">';
          html += '<h1 data-editable data-field="headline">' + escapeHtml(section.content.headline || '') + '</h1>';
          html += '<p data-editable data-field="subheadline">' + escapeHtml(section.content.subheadline || '') + '</p>';
          if (section.content.ctaText) {
            var ctaBtnClass = isDark ? 'cta-btn cta-btn-white' : 'cta-btn';
            html += '<a href="' + escapeHtml(section.content.ctaLink || '#') + '" class="' + ctaBtnClass + '" data-editable-link data-field="ctaText" data-link-field="ctaLink">' + escapeHtml(section.content.ctaText) + '</a>';
          }
          html += '</div>';
        } else if (section.type === 'features') {
          html += '<div class="section-features" data-section-id="' + sectionId + '" data-section-type="features">';
          html += '<h2 data-editable data-field="title">' + escapeHtml(section.content.title || '') + '</h2>';
          html += '<div class="features-grid">';
          (section.content.items || []).forEach(function(item, itemIndex) {
            html += '<div class="feature-item" data-item-index="' + itemIndex + '">';
            html += '<div class="feature-icon"><i class="bi bi-' + escapeHtml(item.icon || 'star') + '"></i></div>';
            html += '<h3 data-editable data-field="items.' + itemIndex + '.title">' + escapeHtml(item.title || '') + '</h3>';
            html += '<p data-editable data-field="items.' + itemIndex + '.description">' + escapeHtml(item.description || '') + '</p>';
            html += '</div>';
          });
          html += '</div></div>';
        } else if (section.type === 'about') {
          html += '<div class="section-about" data-section-id="' + sectionId + '" data-section-type="about">';
          html += '<h2 data-editable data-field="title">' + escapeHtml(section.content.title || '') + '</h2>';
          html += '<p data-editable data-field="content">' + escapeHtml(section.content.content || '') + '</p>';
          html += '</div>';
        } else if (section.type === 'contact') {
          html += '<div class="section-contact" data-section-id="' + sectionId + '" data-section-type="contact">';
          html += '<h2 data-editable data-field="title">' + escapeHtml(section.content.title || '') + '</h2>';
          html += '<p data-editable data-field="subtitle">' + escapeHtml(section.content.subtitle || '') + '</p>';
          if (section.content.email) {
            html += '<p><i class="bi bi-envelope me-2"></i><span data-editable data-field="email">' + escapeHtml(section.content.email) + '</span></p>';
          }
          html += '</div>';
        } else if (section.type === 'footer') {
          var copyright = section.content.copyright || ('© ' + new Date().getFullYear() + ' ' + (section.content.companyName || config.siteName || ''));
          html += '<div class="section-footer" data-section-id="' + sectionId + '" data-section-type="footer">';
          html += '<p data-editable data-field="copyright">' + escapeHtml(copyright) + '</p>';
          html += '</div>';
        }
      });

      html += '</div>';

      if (sections.length > 0) {
        previewFrame.innerHTML = html;
        // Set CSS variables via JavaScript to avoid inline style CSP violation
        var previewEl = document.getElementById('sitePreviewContent');
        if (previewEl) {
          previewEl.style.setProperty('--primary-color', primaryColor);
          previewEl.style.setProperty('--secondary-color', secondaryColor);
        }
        // Apply hero background colors from data attributes (CSP-compliant)
        var heroEl = previewFrame.querySelector('.section-hero');
        if (heroEl) {
          var bgStart = heroEl.getAttribute('data-bg-start');
          var bgEnd = heroEl.getAttribute('data-bg-end');
          if (bgStart && bgEnd) {
            heroEl.style.background = 'linear-gradient(135deg, ' + bgStart + ', ' + bgEnd + ')';
            console.log('[Builder] Applied hero background:', bgStart, '->', bgEnd);
          }
        }
        // Initialize editable elements
        initEditableElements();
      } else {
        previewFrame.innerHTML = '<div class="empty-state"><i class="bi bi-easel"></i><h5>No preview yet</h5><p>Describe your website in the chat to get started!</p></div>';
      }
    }

    // ============================================
    // WYSIWYG INLINE EDITING
    // ============================================

    var currentEditElement = null;
    var currentLinkElement = null;
    var originalContent = '';
    var saveTimeout = null;

    // Initialize editable elements with event listeners
    function initEditableElements() {
      // Text editable elements
      var editables = previewFrame.querySelectorAll('[data-editable]');
      editables.forEach(function(el) {
        el.addEventListener('click', handleEditableClick);
        el.addEventListener('blur', handleEditableBlur);
        el.addEventListener('keydown', handleEditableKeydown);
      });

      // Link/button editable elements
      var links = previewFrame.querySelectorAll('[data-editable-link]');
      links.forEach(function(el) {
        el.addEventListener('click', handleLinkClick);
      });
    }

    // Handle click on editable text element
    function handleEditableClick(e) {
      e.preventDefault();
      e.stopPropagation();

      var el = e.target;
      if (el.getAttribute('contenteditable') === 'true') return;

      // Store original content for cancel
      originalContent = el.textContent;
      currentEditElement = el;

      // Make editable
      el.setAttribute('contenteditable', 'true');
      el.focus();

      // Select all text
      var range = document.createRange();
      range.selectNodeContents(el);
      var sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    }

    // Handle blur (save changes)
    function handleEditableBlur(e) {
      var el = e.target;
      if (el.getAttribute('contenteditable') !== 'true') return;

      el.setAttribute('contenteditable', 'false');

      var newContent = el.textContent.trim();
      if (newContent !== originalContent) {
        saveTextEdit(el, newContent);
      }

      currentEditElement = null;
      originalContent = '';
    }

    // Handle keydown (Enter to save, Escape to cancel)
    function handleEditableKeydown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        e.target.blur();
      } else if (e.key === 'Escape') {
        e.preventDefault();
        e.target.textContent = originalContent;
        e.target.blur();
      }
    }

    // Handle click on link/button element
    function handleLinkClick(e) {
      e.preventDefault();
      e.stopPropagation();

      currentLinkElement = e.target;
      var popup = document.getElementById('linkEditPopup');
      var textInput = document.getElementById('linkEditText');
      var urlInput = document.getElementById('linkEditUrl');

      // Pre-fill with current values
      textInput.value = currentLinkElement.textContent;
      urlInput.value = currentLinkElement.getAttribute('href') || '';

      // Position popup near the element
      var rect = currentLinkElement.getBoundingClientRect();
      popup.style.top = (rect.bottom + 10) + 'px';
      popup.style.left = Math.max(10, rect.left) + 'px';
      popup.classList.add('active');

      textInput.focus();
      textInput.select();
    }

    // Save link edit
    function saveLinkEdit() {
      if (!currentLinkElement) return;

      var textInput = document.getElementById('linkEditText');
      var urlInput = document.getElementById('linkEditUrl');
      var newText = textInput.value.trim();
      var newUrl = urlInput.value.trim();

      if (newText) {
        currentLinkElement.textContent = newText;
      }
      if (newUrl) {
        currentLinkElement.setAttribute('href', newUrl);
      }

      // Save to config
      var section = currentLinkElement.closest('[data-section-id]');
      var sectionId = section.getAttribute('data-section-id');
      var textField = currentLinkElement.getAttribute('data-field');
      var linkField = currentLinkElement.getAttribute('data-link-field');

      var updates = {};
      if (newText) updates[textField] = newText;
      if (newUrl) updates[linkField] = newUrl;

      saveToBackend(sectionId, updates);
      closeLinkEdit();
    }

    // Close link edit popup
    function closeLinkEdit() {
      document.getElementById('linkEditPopup').classList.remove('active');
      currentLinkElement = null;
    }

    // Save text edit to config
    function saveTextEdit(el, newContent) {
      var section = el.closest('[data-section-id]');
      if (!section) return;

      var sectionId = section.getAttribute('data-section-id');
      var field = el.getAttribute('data-field');

      var updates = {};

      // Handle nested fields like items.0.title
      if (field.includes('.')) {
        var parts = field.split('.');
        if (parts[0] === 'items') {
          var itemIndex = parseInt(parts[1]);
          var itemField = parts[2];
          // We need to get the full items array and update it
          var currentSection = siteData.draftConfig.sections.find(s => s.id === sectionId);
          if (currentSection && currentSection.content.items) {
            var items = JSON.parse(JSON.stringify(currentSection.content.items));
            items[itemIndex][itemField] = newContent;
            updates.items = items;
          }
        }
      } else {
        updates[field] = newContent;
      }

      saveToBackend(sectionId, updates);
    }

    // Save changes to backend (debounced)
    function saveToBackend(sectionId, contentUpdates) {
      // Update local config immediately
      var section = siteData.draftConfig.sections.find(s => s.id === sectionId);
      if (section) {
        Object.assign(section.content, contentUpdates);
      }

      // Debounce backend save
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(function() {
        console.log('[Builder] Auto-saving changes:', sectionId, contentUpdates);

        fetch('/api/sites/' + siteId, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ draftConfig: siteData.draftConfig })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.success) {
            console.log('[Builder] Auto-save successful');
            // Show brief save indicator
            showSaveIndicator();
          } else {
            console.error('[Builder] Auto-save failed:', data.error);
          }
        })
        .catch(function(err) {
          console.error('[Builder] Auto-save error:', err);
        });
      }, 500);
    }

    // Show save indicator
    function showSaveIndicator() {
      var indicator = document.createElement('div');
      indicator.textContent = '✓ Saved';
      indicator.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #28a745; color: white; padding: 8px 16px; border-radius: 4px; font-size: 14px; z-index: 1000;';
      document.body.appendChild(indicator);
      setTimeout(function() { indicator.remove(); }, 2000);
    }

    // Close link popup when clicking outside
    document.addEventListener('click', function(e) {
      var popup = document.getElementById('linkEditPopup');
      if (popup.classList.contains('active') && !popup.contains(e.target) && e.target !== currentLinkElement) {
        closeLinkEdit();
      }
    });

    // ============================================
    // END WYSIWYG
    // ============================================

    // Escape HTML
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Publish site
    async function publishSite() {
      if (!siteId || isProcessing) return;

      if (!confirm('Ready to publish your site? It will be live at ' + siteData.slug + '.devopser.io')) {
        return;
      }

      publishBtn.disabled = true;
      publishBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Publishing...';

      try {
        const response = await fetch(`/api/sites/${siteId}/publish`, {
          method: 'POST',
          credentials: 'same-origin'
        });

        const data = await response.json();

        if (data.success) {
          addMessage('system', 'Deployment started! Your site will be live shortly at ' + siteData.slug + '.devopser.io');
          // Reload after a delay to show updated status
          setTimeout(() => location.reload(), 3000);
        } else {
          addMessage('system', 'Error: ' + (data.error || 'Failed to publish'));
          publishBtn.disabled = false;
          publishBtn.innerHTML = '<i class="bi bi-rocket-takeoff me-1"></i> Publish';
        }
      } catch (error) {
        console.error('Publish error:', error);
        addMessage('system', 'Error: Failed to publish. Please try again.');
        publishBtn.disabled = false;
        publishBtn.innerHTML = '<i class="bi bi-rocket-takeoff me-1"></i> Publish';
      }
    }

    // Event listeners
    sendBtn.addEventListener('click', sendMessage);

    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    if (publishBtn) {
      publishBtn.addEventListener('click', publishSite);
    }

    if (refreshPreviewBtn) {
      refreshPreviewBtn.addEventListener('click', () => {
        if (siteData && siteData.draftConfig) {
          refreshPreview(siteData.draftConfig);
        }
      });
    }

    // Delete site (in status dropdown)
    const deleteSiteBtn = document.getElementById('delete-site-btn');
    if (deleteSiteBtn) {
      deleteSiteBtn.addEventListener('click', async () => {
        const siteName = siteData ? siteData.name : 'this site';
        const confirmMsg = `Are you sure you want to delete "${siteName}"?\n\nThis action cannot be undone. All site data will be permanently deleted.`;

        if (!confirm(confirmMsg)) {
          return;
        }

        // Double confirm for safety
        const confirmAgain = prompt(`Type "DELETE" to confirm deletion of "${siteName}":`);
        if (confirmAgain !== 'DELETE') {
          alert('Deletion cancelled. You must type DELETE to confirm.');
          return;
        }

        deleteSiteBtn.disabled = true;
        deleteSiteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Deleting...';

        try {
          const response = await fetch(`/api/sites/${siteId}`, {
            method: 'DELETE',
            credentials: 'same-origin'
          });

          const data = await response.json();

          if (data.success) {
            alert('Site deleted successfully.');
            window.location.href = '/sites';
          } else {
            alert('Error: ' + (data.error || 'Failed to delete site'));
            deleteSiteBtn.disabled = false;
            deleteSiteBtn.innerHTML = '<i class="bi bi-trash me-1"></i> Delete Site';
          }
        } catch (error) {
          console.error('Delete error:', error);
          alert('Error: Failed to delete site. Please try again.');
          deleteSiteBtn.disabled = false;
          deleteSiteBtn.innerHTML = '<i class="bi bi-trash me-1"></i> Delete Site';
        }
      });
    }

    // Apply hero background from data attributes on page load (CSP-compliant)
    function applyHeroBackground() {
      var heroEl = document.querySelector('.section-hero');
      if (heroEl) {
        var bgStart = heroEl.getAttribute('data-bg-start');
        var bgEnd = heroEl.getAttribute('data-bg-end');
        if (bgStart && bgEnd) {
          heroEl.style.background = 'linear-gradient(135deg, ' + bgStart + ', ' + bgEnd + ')';
        }
      }
    }
    applyHeroBackground();
    initEditableElements();

    // Focus chat input on load
    chatInput.focus();
  </script>
</body>
</html>
