<!-- DevOpser Lite Website Builder Template -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= site ? site.name + ' - DevOpser Builder' : 'DevOpser Lite' %></title>
  <link rel="icon" href="/static/icon.png" type="image/png">

  <!-- CSS Files -->
  <link rel="stylesheet" href="/static/css/litera-bootstrap.min.css">
  <link rel="stylesheet" href="/static/css/bootstrap-icons.css">
  <link rel="stylesheet" href="/static/nav.css">

  <!-- Builder-specific styles -->
  <style nonce="<%= cspNonce %>">
    :root {
      --sidebar-width: 350px;
      --preview-bg: #f8f9fa;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    .builder-container {
      display: flex;
      height: calc(100vh - 56px);
    }

    /* Chat Sidebar */
    .chat-sidebar {
      width: var(--sidebar-width);
      min-width: var(--sidebar-width);
      background: #fff;
      border-right: 1px solid #dee2e6;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      padding: 1rem;
      border-bottom: 1px solid #dee2e6;
      background: #f8f9fa;
    }

    .chat-header h5 {
      margin: 0;
      font-weight: 600;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .chat-message {
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      max-width: 90%;
    }

    .chat-message.user {
      background: #0d6efd;
      color: white;
      margin-left: auto;
    }

    .chat-message.assistant {
      background: #e9ecef;
      color: #212529;
    }

    .chat-message.system {
      background: #fff3cd;
      color: #856404;
      font-size: 0.875rem;
      text-align: center;
      max-width: 100%;
    }

    .chat-input-container {
      padding: 1rem;
      border-top: 1px solid #dee2e6;
      background: #f8f9fa;
    }

    .chat-input-container textarea {
      width: 100%;
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      padding: 0.75rem;
      resize: none;
      font-size: 0.95rem;
    }

    .chat-input-container textarea:focus {
      outline: none;
      border-color: #0d6efd;
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
    }

    .chat-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    /* Preview Area */
    .preview-area {
      flex: 1;
      background: var(--preview-bg);
      display: flex;
      flex-direction: column;
    }

    .preview-header {
      padding: 0.75rem 1rem;
      background: #fff;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .preview-url {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: #f8f9fa;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-family: monospace;
      font-size: 0.875rem;
      color: #6c757d;
    }

    .preview-actions {
      display: flex;
      gap: 0.5rem;
    }

    .preview-frame-container {
      flex: 1;
      padding: 1rem;
      overflow: hidden;
    }

    .preview-frame {
      width: 100%;
      height: 100%;
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      overflow: auto;
    }

    /* Site Preview Renderer */
    .site-preview {
      font-family: 'Inter', system-ui, sans-serif;
    }

    .section-hero {
      padding: 4rem 2rem;
      text-align: center;
      background: linear-gradient(135deg, var(--primary-color, #3B82F6), var(--secondary-color, #8B5CF6));
      color: white;
    }

    .section-hero h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }

    .section-hero p {
      font-size: 1.25rem;
      opacity: 0.9;
      margin-bottom: 2rem;
    }

    .section-hero .cta-btn {
      background: white;
      color: var(--primary-color, #3B82F6);
      padding: 0.75rem 2rem;
      border-radius: 0.5rem;
      font-weight: 600;
      text-decoration: none;
      display: inline-block;
    }

    .section-features {
      padding: 4rem 2rem;
      background: #fff;
    }

    .section-features h2 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 3rem;
    }

    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
      max-width: 1000px;
      margin: 0 auto;
    }

    .feature-item {
      text-align: center;
      padding: 1.5rem;
    }

    .feature-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: var(--primary-color, #3B82F6);
    }

    .feature-item h3 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }

    .feature-item p {
      color: #6c757d;
      font-size: 0.95rem;
    }

    .section-about {
      padding: 4rem 2rem;
      background: #f8f9fa;
    }

    .section-contact {
      padding: 4rem 2rem;
      background: #fff;
    }

    .section-footer {
      padding: 2rem;
      background: #212529;
      color: white;
      text-align: center;
    }

    /* Status badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-draft { background: #ffc107; color: #212529; }
    .status-deploying { background: #17a2b8; color: white; }
    .status-published { background: #28a745; color: white; }
    .status-failed { background: #dc3545; color: white; }

    /* Empty state */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #6c757d;
      text-align: center;
      padding: 2rem;
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .loading-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #6c757d;
    }

    .loading-indicator .spinner-border {
      width: 1rem;
      height: 1rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .builder-container {
        flex-direction: column;
      }

      .chat-sidebar {
        width: 100%;
        height: 50%;
      }

      .preview-area {
        height: 50%;
      }
    }
  </style>

  <script src="/static/js/bootstrap.bundle.min.js" defer></script>
</head>
<body>
  <header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="/sites">DevOpser Lite</a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="/sites">My Sites</a>
            </li>
          </ul>
          <ul class="navbar-nav">
            <% if (site) { %>
            <li class="nav-item">
              <span class="nav-link">
                <span class="status-badge status-<%= site.status %>">
                  <i class="bi bi-circle-fill" style="font-size: 0.5rem;"></i>
                  <%= site.status.charAt(0).toUpperCase() + site.status.slice(1) %>
                </span>
              </span>
            </li>
            <% } %>
            <li class="nav-item">
              <a class="nav-link" href="/account">Account</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/auth/logout">Logout</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <main class="builder-container">
    <!-- Chat Sidebar -->
    <div class="chat-sidebar">
      <div class="chat-header">
        <h5><i class="bi bi-chat-dots me-2"></i>Build with AI</h5>
        <% if (site) { %>
        <small class="text-muted"><%= site.name %></small>
        <% } %>
      </div>

      <div class="chat-messages" id="chat-messages">
        <% if (!site || !site.draftConfig || !site.draftConfig.sections || site.draftConfig.sections.length === 0) { %>
        <div class="chat-message system">
          <i class="bi bi-lightbulb me-1"></i>
          Describe your website and I'll create it for you! For example: "I want a landing page for a fitness app"
        </div>
        <% } else { %>
        <div class="chat-message system">
          <i class="bi bi-check-circle me-1"></i>
          Your site is ready! Ask me to make changes, like "make the headline more exciting" or "add a pricing section"
        </div>
        <% } %>
      </div>

      <div class="chat-input-container">
        <textarea
          id="chat-input"
          placeholder="Describe what you want..."
          rows="3"
        ></textarea>
        <div class="chat-actions">
          <button id="send-btn" class="btn btn-primary flex-grow-1">
            <i class="bi bi-send me-1"></i> Send
          </button>
          <% if (site && site.draftConfig && site.draftConfig.sections && site.draftConfig.sections.length > 0) { %>
          <button id="publish-btn" class="btn btn-success" <%= site.status === 'deploying' ? 'disabled' : '' %>>
            <i class="bi bi-rocket-takeoff me-1"></i> Publish
          </button>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Preview Area -->
    <div class="preview-area">
      <div class="preview-header">
        <div class="preview-url">
          <i class="bi bi-globe"></i>
          <% if (site) { %>
          <span><%= site.slug %>.devopser.io</span>
          <% } else { %>
          <span>your-site.devopser.io</span>
          <% } %>
        </div>
        <div class="preview-actions">
          <button class="btn btn-outline-secondary btn-sm" id="refresh-preview">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
          <% if (site && site.status === 'published') { %>
          <a href="<%= site.publicUrl %>" target="_blank" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-box-arrow-up-right me-1"></i> View Live
          </a>
          <% } %>
        </div>
      </div>

      <div class="preview-frame-container">
        <div class="preview-frame" id="preview-frame">
          <% if (site && site.draftConfig && site.draftConfig.sections && site.draftConfig.sections.length > 0) { %>
          <!-- Render site preview -->
          <div class="site-preview" id="site-preview">
            <%
            const config = site.draftConfig;
            const primaryColor = config.theme?.primaryColor || '#3B82F6';
            const secondaryColor = config.theme?.secondaryColor || '#10B981';
            %>
            <style nonce="<%= cspNonce %>">
              .site-preview { --primary-color: <%= primaryColor %>; --secondary-color: <%= secondaryColor %>; }
            </style>

            <% config.sections.filter(s => s.visible !== false).sort((a,b) => a.order - b.order).forEach(section => { %>
              <% if (section.type === 'hero') { %>
              <div class="section-hero">
                <h1><%= section.content.headline %></h1>
                <p><%= section.content.subheadline %></p>
                <% if (section.content.ctaText) { %>
                <a href="<%= section.content.ctaLink || '#' %>" class="cta-btn"><%= section.content.ctaText %></a>
                <% } %>
              </div>
              <% } else if (section.type === 'features') { %>
              <div class="section-features">
                <h2><%= section.content.title %></h2>
                <div class="features-grid">
                  <% (section.content.items || []).forEach(item => { %>
                  <div class="feature-item">
                    <div class="feature-icon"><i class="bi bi-<%= item.icon || 'star' %>"></i></div>
                    <h3><%= item.title %></h3>
                    <p><%= item.description %></p>
                  </div>
                  <% }) %>
                </div>
              </div>
              <% } else if (section.type === 'about') { %>
              <div class="section-about">
                <h2><%= section.content.title %></h2>
                <p><%= section.content.content %></p>
              </div>
              <% } else if (section.type === 'contact') { %>
              <div class="section-contact">
                <h2><%= section.content.title %></h2>
                <p><%= section.content.subtitle %></p>
                <% if (section.content.email) { %>
                <p><i class="bi bi-envelope me-2"></i><%= section.content.email %></p>
                <% } %>
              </div>
              <% } else if (section.type === 'footer') { %>
              <div class="section-footer">
                <p><%= section.content.copyright || '© ' + new Date().getFullYear() + ' ' + (section.content.companyName || config.siteName) %></p>
              </div>
              <% } %>
            <% }) %>
          </div>
          <% } else { %>
          <div class="empty-state">
            <i class="bi bi-easel"></i>
            <h5>No preview yet</h5>
            <p>Describe your website in the chat to get started!</p>
          </div>
          <% } %>
        </div>
      </div>
    </div>
  </main>

  <script nonce="<%= cspNonce %>">
    // Site data from server
    const siteId = '<%= site ? site.id : "" %>';
    const siteData = <%- site ? JSON.stringify(site) : 'null' %>;

    // Chat functionality
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const publishBtn = document.getElementById('publish-btn');
    const previewFrame = document.getElementById('preview-frame');
    const refreshPreviewBtn = document.getElementById('refresh-preview');

    let chatHistory = [];
    let isProcessing = false;

    // Add message to chat
    function addMessage(role, content) {
      const div = document.createElement('div');
      div.className = `chat-message ${role}`;
      div.textContent = content;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Send chat message
    async function sendMessage() {
      const message = chatInput.value.trim();
      if (!message || isProcessing || !siteId) return;

      isProcessing = true;
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Processing...';

      // Add user message to chat
      addMessage('user', message);
      chatInput.value = '';

      // Add to history
      chatHistory.push({ role: 'user', content: message });

      try {
        const response = await fetch(`/api/sites/${siteId}/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'same-origin',
          body: JSON.stringify({
            message,
            history: chatHistory
          })
        });

        const data = await response.json();

        if (data.success) {
          // Add AI response to chat
          addMessage('assistant', data.message);
          chatHistory.push({ role: 'assistant', content: data.message });

          // Refresh preview if config changed
          if (data.site && data.site.draftConfig) {
            refreshPreview(data.site.draftConfig);

            // Show publish button if we now have content
            if (data.site.draftConfig.sections && data.site.draftConfig.sections.length > 0) {
              if (!publishBtn) {
                location.reload(); // Reload to show publish button
              }
            }
          }
        } else {
          addMessage('system', 'Error: ' + (data.error || 'Something went wrong'));
        }
      } catch (error) {
        console.error('Chat error:', error);
        addMessage('system', 'Error: Failed to send message. Please try again.');
      }

      isProcessing = false;
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<i class="bi bi-send me-1"></i> Send';
    }

    // Refresh preview with new config
    function refreshPreview(config) {
      const primaryColor = config.theme?.primaryColor || '#3B82F6';
      const secondaryColor = config.theme?.secondaryColor || '#10B981';

      let html = `
        <div class="site-preview" style="--primary-color: ${primaryColor}; --secondary-color: ${secondaryColor};">
      `;

      const sections = (config.sections || [])
        .filter(s => s.visible !== false)
        .sort((a, b) => a.order - b.order);

      sections.forEach(section => {
        if (section.type === 'hero') {
          html += `
            <div class="section-hero">
              <h1>${escapeHtml(section.content.headline || '')}</h1>
              <p>${escapeHtml(section.content.subheadline || '')}</p>
              ${section.content.ctaText ? `<a href="${escapeHtml(section.content.ctaLink || '#')}" class="cta-btn">${escapeHtml(section.content.ctaText)}</a>` : ''}
            </div>
          `;
        } else if (section.type === 'features') {
          html += `
            <div class="section-features">
              <h2>${escapeHtml(section.content.title || '')}</h2>
              <div class="features-grid">
                ${(section.content.items || []).map(item => `
                  <div class="feature-item">
                    <div class="feature-icon"><i class="bi bi-${escapeHtml(item.icon || 'star')}"></i></div>
                    <h3>${escapeHtml(item.title || '')}</h3>
                    <p>${escapeHtml(item.description || '')}</p>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        } else if (section.type === 'about') {
          html += `
            <div class="section-about">
              <h2>${escapeHtml(section.content.title || '')}</h2>
              <p>${escapeHtml(section.content.content || '')}</p>
            </div>
          `;
        } else if (section.type === 'contact') {
          html += `
            <div class="section-contact">
              <h2>${escapeHtml(section.content.title || '')}</h2>
              <p>${escapeHtml(section.content.subtitle || '')}</p>
              ${section.content.email ? `<p><i class="bi bi-envelope me-2"></i>${escapeHtml(section.content.email)}</p>` : ''}
            </div>
          `;
        } else if (section.type === 'footer') {
          html += `
            <div class="section-footer">
              <p>${escapeHtml(section.content.copyright || '© ' + new Date().getFullYear() + ' ' + (section.content.companyName || config.siteName || ''))}</p>
            </div>
          `;
        }
      });

      html += '</div>';

      previewFrame.innerHTML = sections.length > 0 ? html : `
        <div class="empty-state">
          <i class="bi bi-easel"></i>
          <h5>No preview yet</h5>
          <p>Describe your website in the chat to get started!</p>
        </div>
      `;
    }

    // Escape HTML
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Publish site
    async function publishSite() {
      if (!siteId || isProcessing) return;

      if (!confirm('Ready to publish your site? It will be live at ' + siteData.slug + '.devopser.io')) {
        return;
      }

      publishBtn.disabled = true;
      publishBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Publishing...';

      try {
        const response = await fetch(`/api/sites/${siteId}/publish`, {
          method: 'POST',
          credentials: 'same-origin'
        });

        const data = await response.json();

        if (data.success) {
          addMessage('system', 'Deployment started! Your site will be live shortly at ' + siteData.slug + '.devopser.io');
          // Reload after a delay to show updated status
          setTimeout(() => location.reload(), 3000);
        } else {
          addMessage('system', 'Error: ' + (data.error || 'Failed to publish'));
          publishBtn.disabled = false;
          publishBtn.innerHTML = '<i class="bi bi-rocket-takeoff me-1"></i> Publish';
        }
      } catch (error) {
        console.error('Publish error:', error);
        addMessage('system', 'Error: Failed to publish. Please try again.');
        publishBtn.disabled = false;
        publishBtn.innerHTML = '<i class="bi bi-rocket-takeoff me-1"></i> Publish';
      }
    }

    // Event listeners
    sendBtn.addEventListener('click', sendMessage);

    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    if (publishBtn) {
      publishBtn.addEventListener('click', publishSite);
    }

    if (refreshPreviewBtn) {
      refreshPreviewBtn.addEventListener('click', () => {
        if (siteData && siteData.draftConfig) {
          refreshPreview(siteData.draftConfig);
        }
      });
    }

    // Focus chat input on load
    chatInput.focus();
  </script>
</body>
</html>
