<!-- DevOpser Lite Website Builder Template -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= site ? site.name + ' - DevOpser Builder' : 'DevOpser Lite' %></title>
  <link rel="icon" href="/static/icon.png" type="image/png">

  <!-- CSS Files -->
  <link rel="stylesheet" href="/static/css/litera-bootstrap.min.css">
  <link rel="stylesheet" href="/static/fontawesome/all.min.css">
  <link rel="stylesheet" href="/static/nav.css">

  <!-- Builder-specific styles -->
  <style nonce="<%= cspNonce %>">
    :root {
      --sidebar-width: 350px;
      --preview-bg: #f8f9fa;
      --primary-color: #3B82F6;
      --secondary-color: #10B981;
    }

    /* Status icon - small dot */
    .status-icon-dot {
      font-size: 0.5rem;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    .builder-container {
      display: flex;
      height: calc(100vh - 56px);
    }

    /* Chat Sidebar */
    .chat-sidebar {
      width: var(--sidebar-width);
      min-width: var(--sidebar-width);
      background: #fff;
      border-right: 1px solid #dee2e6;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      padding: 1rem;
      border-bottom: 1px solid #dee2e6;
      background: #f8f9fa;
    }

    .chat-header h5 {
      margin: 0;
      font-weight: 600;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .chat-message {
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      max-width: 90%;
    }

    .chat-message.user {
      background: #0d6efd;
      color: white;
      margin-left: auto;
    }

    .chat-message.assistant {
      background: #e9ecef;
      color: #212529;
    }

    .chat-message.system {
      background: #fff3cd;
      color: #856404;
      font-size: 0.875rem;
      text-align: center;
      max-width: 100%;
    }

    .chat-message.tools-used {
      background: #d1e7dd;
      color: #0f5132;
      font-size: 0.75rem;
      text-align: center;
      max-width: 100%;
      padding: 0.5rem;
    }

    /* Markdown styles for assistant messages */
    .chat-message.assistant h4,
    .chat-message.assistant h5,
    .chat-message.assistant h6 {
      margin: 0.5rem 0 0.25rem 0;
      font-weight: 600;
    }
    .chat-message.assistant h4 { font-size: 1.1rem; }
    .chat-message.assistant h5 { font-size: 1rem; }
    .chat-message.assistant h6 { font-size: 0.95rem; }

    .chat-message.assistant strong {
      font-weight: 600;
    }

    .chat-message.assistant em {
      font-style: italic;
    }

    .chat-message.assistant code {
      background: rgba(0,0,0,0.08);
      padding: 0.1rem 0.3rem;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
    }

    .chat-message.assistant pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 0.75rem;
      border-radius: 4px;
      overflow-x: auto;
      margin: 0.5rem 0;
    }

    .chat-message.assistant pre code {
      background: none;
      padding: 0;
      color: inherit;
    }

    .chat-message.assistant ul,
    .chat-message.assistant ol {
      margin: 0.5rem 0;
      padding-left: 1.5rem;
    }

    .chat-message.assistant li {
      margin: 0.25rem 0;
    }

    .chat-input-container {
      padding: 1rem;
      border-top: 1px solid #dee2e6;
      background: #f8f9fa;
    }

    .chat-input-container textarea {
      width: 100%;
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      padding: 0.75rem;
      resize: none;
      font-size: 0.95rem;
    }

    .chat-input-container textarea:focus {
      outline: none;
      border-color: #0d6efd;
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
    }

    .chat-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    /* Preview Area */
    .preview-area {
      flex: 1;
      background: var(--preview-bg);
      display: flex;
      flex-direction: column;
    }

    .preview-header {
      padding: 0.75rem 1rem;
      background: #fff;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .preview-url {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: #f8f9fa;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-family: monospace;
      font-size: 0.875rem;
      color: #6c757d;
    }

    .preview-actions {
      display: flex;
      gap: 0.5rem;
    }

    .preview-frame-container {
      flex: 1;
      padding: 1rem;
      overflow: hidden;
    }

    .preview-frame {
      width: 100%;
      height: 100%;
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      overflow: auto;
    }

    /* Site Preview Renderer */
    .site-preview {
      font-family: 'Inter', system-ui, sans-serif;
    }

    /* Site Navigation Bar */
    .site-nav {
      background: #ffffff;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .site-nav-logo {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary-color, #3B82F6);
      text-decoration: none;
    }

    .site-nav-links {
      display: flex;
      gap: 1.5rem;
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .site-nav-links a {
      color: #374151;
      text-decoration: none;
      font-size: 0.95rem;
      font-weight: 500;
      transition: color 0.2s;
    }

    .site-nav-links a:hover {
      color: var(--primary-color, #3B82F6);
    }

    .site-nav-links a.active {
      color: var(--primary-color, #3B82F6);
    }

    .section-hero {
      padding: 4rem 2rem;
      text-align: center;
      background: linear-gradient(135deg, var(--primary-color, #3B82F6), var(--secondary-color, #8B5CF6));
      color: white;
    }

    .section-hero h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }

    .section-hero p {
      font-size: 1.25rem;
      opacity: 0.9;
      margin-bottom: 2rem;
    }

    .section-hero .cta-btn {
      background: white;
      color: var(--primary-color, #3B82F6);
      padding: 0.75rem 2rem;
      border-radius: 0.5rem;
      font-weight: 600;
      text-decoration: none;
      display: inline-block;
    }

    .section-hero .cta-btn-white {
      background: white;
      color: #1a1a1a;
    }

    .section-hero.dark-bg h1,
    .section-hero.dark-bg p {
      color: white;
    }

    /* WYSIWYG Editable Elements */
    [data-editable] {
      cursor: pointer;
      transition: outline 0.2s, background 0.2s;
      border-radius: 4px;
    }

    [data-editable]:hover {
      outline: 2px dashed rgba(13, 110, 253, 0.5);
      outline-offset: 4px;
    }

    [data-editable]:focus {
      outline: 2px solid #0d6efd;
      outline-offset: 4px;
      background: rgba(255, 255, 255, 0.1);
    }

    [data-editable][contenteditable="true"] {
      cursor: text;
    }

    /* Edit hint tooltip */
    [data-editable]::after {
      content: 'Click to edit';
      position: absolute;
      top: -24px;
      left: 50%;
      transform: translateX(-50%);
      background: #0d6efd;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      white-space: nowrap;
    }

    [data-editable]:hover::after {
      opacity: 1;
    }

    [data-editable]:focus::after {
      content: 'Press Enter to save, Esc to cancel';
    }

    /* Make editable elements position relative for tooltip */
    .section-hero h1,
    .section-hero p,
    .section-features h2,
    .feature-item h3,
    .feature-item p,
    .section-about h2,
    .section-about p,
    .section-contact h2,
    .section-contact p,
    .cta-btn {
      position: relative;
    }

    /* Link edit popup */
    .link-edit-popup {
      position: fixed;
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      display: none;
    }

    .link-edit-popup.active {
      display: block;
    }

    .link-edit-popup input {
      width: 250px;
      padding: 8px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      font-size: 14px;
    }

    .link-edit-popup .btn-group {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }

    .link-edit-popup button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      pointer-events: auto;
      position: relative;
      z-index: 1001;
    }

    .link-edit-popup .btn-save {
      background: #0d6efd;
      color: white;
    }

    .link-edit-popup .btn-cancel {
      background: #6c757d;
      color: white;
    }

    .link-edit-popup .popup-title {
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 13px;
    }

    .link-edit-popup .form-group {
      margin-bottom: 8px;
    }

    .link-edit-popup label {
      display: block;
      font-size: 12px;
      color: #6c757d;
      margin-bottom: 4px;
    }

    /* Icon picker popup */
    .icon-picker-popup {
      position: fixed;
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      display: none;
      width: 280px;
    }

    .icon-picker-popup.active {
      display: block;
    }

    .icon-picker-popup .popup-title {
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 13px;
    }

    .icon-picker-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 4px;
      max-height: 200px;
      overflow-y: auto;
    }

    .icon-picker-item {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      cursor: pointer;
      font-size: 18px;
      color: #495057;
      transition: all 0.15s;
    }

    .icon-picker-item:hover {
      background: #e9ecef;
      border-color: #0d6efd;
    }

    .icon-picker-item.selected {
      background: #0d6efd;
      color: white;
      border-color: #0d6efd;
    }

    /* Editable icon styling */
    [data-editable-icon] {
      cursor: pointer;
      transition: transform 0.2s, background 0.2s;
      border-radius: 50%;
      padding: 8px;
    }

    [data-editable-icon]:hover {
      background: rgba(13, 110, 253, 0.1);
      transform: scale(1.1);
    }

    [data-editable-icon]::after {
      content: 'Click to change';
      position: absolute;
      bottom: -24px;
      left: 50%;
      transform: translateX(-50%);
      background: #0d6efd;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      white-space: nowrap;
    }

    [data-editable-icon]:hover::after {
      opacity: 1;
    }

    .feature-icon {
      position: relative;
    }

    /* Drag and drop section reordering */
    [data-section-id] {
      position: relative;
    }

    .section-drag-handle {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #dee2e6;
      border-radius: 6px;
      cursor: grab;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s, background 0.2s;
      z-index: 10;
      color: #6c757d;
      font-size: 16px;
    }

    [data-section-id]:hover .section-drag-handle {
      opacity: 1;
    }

    .section-drag-handle:hover {
      background: #fff;
      color: #0d6efd;
      border-color: #0d6efd;
    }

    .section-drag-handle:active {
      cursor: grabbing;
    }

    [data-section-id].dragging {
      opacity: 0.5;
      outline: 2px dashed #0d6efd;
      outline-offset: -2px;
    }

    [data-section-id].drag-over {
      outline: 3px solid #0d6efd;
      outline-offset: -3px;
    }

    .drop-indicator {
      height: 4px;
      background: #0d6efd;
      margin: 0;
      border-radius: 2px;
      transition: all 0.2s;
    }

    .drop-indicator-top {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: #0d6efd;
      opacity: 0;
      z-index: 100;
    }

    .drop-indicator-bottom {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: #0d6efd;
      opacity: 0;
      z-index: 100;
    }

    [data-section-id].drag-over-top .drop-indicator-top {
      opacity: 1;
    }

    [data-section-id].drag-over-bottom .drop-indicator-bottom {
      opacity: 1;
    }

    /* Drag handle on dark backgrounds (hero section) */
    .section-hero .section-drag-handle {
      background: rgba(0, 0, 0, 0.6);
      border-color: rgba(255, 255, 255, 0.3);
      color: white;
    }

    .section-hero .section-drag-handle:hover {
      background: rgba(0, 0, 0, 0.8);
      border-color: white;
      color: white;
    }

    /* Save indicator toast */
    .save-indicator {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #28a745;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 8px;
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 1.7s forwards;
    }

    .save-indicator.saving {
      background: #0d6efd;
    }

    .save-indicator.error {
      background: #dc3545;
    }

    .save-indicator i {
      font-size: 16px;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(100px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* Saving spinner */
    .save-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .section-features {
      padding: 4rem 2rem;
      background: #fff;
    }

    .section-features h2 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 3rem;
    }

    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
      max-width: 1000px;
      margin: 0 auto;
    }

    .feature-item {
      text-align: center;
      padding: 1.5rem;
    }

    .feature-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: var(--primary-color, #3B82F6);
    }

    .feature-item h3 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }

    .feature-item p {
      color: #6c757d;
      font-size: 0.95rem;
    }

    .section-about {
      padding: 4rem 2rem;
      background: #f8f9fa;
    }

    .section-contact {
      padding: 4rem 2rem;
      background: #fff;
    }

    /* Testimonials section */
    .section-testimonials {
      padding: 4rem 2rem;
      background: #f8f9fa;
    }

    .section-testimonials h2 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 3rem;
    }

    .testimonials-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
      max-width: 1000px;
      margin: 0 auto;
    }

    .testimonial-item {
      background: white;
      padding: 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .testimonial-quote {
      font-style: italic;
      color: #4a5568;
      margin-bottom: 1rem;
      line-height: 1.6;
    }

    .testimonial-author {
      font-weight: 600;
      color: #1a202c;
    }

    .testimonial-role {
      font-size: 0.875rem;
      color: #718096;
    }

    /* Pricing section */
    .section-pricing {
      padding: 4rem 2rem;
      background: #fff;
    }

    .section-pricing h2 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .section-pricing .pricing-subtitle {
      text-align: center;
      color: #6c757d;
      margin-bottom: 3rem;
    }

    .pricing-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
      max-width: 900px;
      margin: 0 auto;
    }

    .pricing-item {
      background: #f8f9fa;
      padding: 2rem;
      border-radius: 0.5rem;
      text-align: center;
      border: 2px solid transparent;
    }

    .pricing-item.highlighted {
      border-color: var(--primary-color, #3B82F6);
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .pricing-name {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .pricing-price {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary-color, #3B82F6);
    }

    .pricing-period {
      font-size: 1rem;
      color: #6c757d;
    }

    .pricing-features {
      list-style: none;
      padding: 0;
      margin: 1.5rem 0;
      text-align: left;
    }

    .pricing-features li {
      padding: 0.5rem 0;
      color: #4a5568;
    }

    .pricing-features li::before {
      content: 'âœ“';
      color: var(--primary-color, #3B82F6);
      margin-right: 0.5rem;
    }

    /* Editable list items */
    [data-editable-list-item] {
      cursor: pointer;
      transition: background 0.2s;
      border-radius: 4px;
      position: relative;
    }

    [data-editable-list-item]:hover {
      background: rgba(13, 110, 253, 0.1);
    }

    [data-editable-list-item]:focus {
      outline: 2px solid #0d6efd;
      outline-offset: 2px;
      background: rgba(255, 255, 255, 0.1);
    }

    [data-editable-list-item].editing {
      outline: 2px solid #0d6efd;
    }

    /* Delete button for list items */
    .list-item-delete {
      position: absolute;
      right: -24px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
      opacity: 0;
      transition: opacity 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    [data-editable-list-item]:hover .list-item-delete,
    [data-editable-list-item]:focus .list-item-delete {
      opacity: 1;
    }

    /* Add item button */
    .list-add-item {
      margin-top: 8px;
      padding: 4px 12px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    [data-editable-list]:hover .list-add-item {
      opacity: 1;
    }

    .pricing-cta {
      display: inline-block;
      padding: 0.75rem 2rem;
      background: var(--primary-color, #3B82F6);
      color: white;
      text-decoration: none;
      border-radius: 0.5rem;
      font-weight: 600;
    }

    .section-footer {
      padding: 2rem;
      background: #212529;
      color: white;
      text-align: center;
    }

    /* Status badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-draft { background: #ffc107; color: #212529; }
    .status-deploying { background: #17a2b8; color: white; }
    .status-published { background: #28a745; color: white; }
    .status-failed { background: #dc3545; color: white; }

    /* Empty state */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #6c757d;
      text-align: center;
      padding: 2rem;
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .loading-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #6c757d;
    }

    .loading-indicator .spinner-border {
      width: 1rem;
      height: 1rem;
    }

    /* Page tabs for multi-page sites */
    .page-tabs {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      overflow-x: auto;
    }

    .page-tab {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      cursor: pointer;
      white-space: nowrap;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .page-tab:hover {
      background: #e9ecef;
    }

    .page-tab.active {
      background: var(--primary-color, #3B82F6);
      color: white;
      border-color: var(--primary-color, #3B82F6);
    }

    .page-tab .delete-page {
      opacity: 0;
      margin-left: 0.25rem;
      padding: 0.125rem 0.25rem;
      border-radius: 0.25rem;
      transition: opacity 0.2s;
    }

    .page-tab:hover .delete-page {
      opacity: 0.7;
    }

    .page-tab .delete-page:hover {
      opacity: 1;
      background: rgba(220, 53, 69, 0.2);
    }

    .add-page-btn {
      padding: 0.5rem;
      background: transparent;
      border: 1px dashed #dee2e6;
      border-radius: 0.375rem;
      color: #6c757d;
      cursor: pointer;
      transition: all 0.2s;
    }

    .add-page-btn:hover {
      background: #e9ecef;
      border-color: #adb5bd;
      color: #212529;
    }

    /* Team Section */
    .section-team {
      padding: 4rem 2rem;
      background: #f8f9fa;
    }

    .section-team h2 {
      text-align: center;
      margin-bottom: 0.5rem;
    }

    .section-team .team-subtitle {
      text-align: center;
      color: #6c757d;
      margin-bottom: 2rem;
    }

    .team-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .team-member {
      background: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .team-member-photo {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 1rem;
      background: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
    }

    .team-member-photo i {
      font-size: 3rem;
      color: #adb5bd;
    }

    .team-member-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .team-member h3 {
      font-size: 1.125rem;
      margin-bottom: 0.25rem;
    }

    .team-member .role {
      color: var(--primary-color, #3B82F6);
      font-size: 0.875rem;
      margin-bottom: 0.75rem;
    }

    .team-member .bio {
      color: #6c757d;
      font-size: 0.875rem;
      line-height: 1.5;
    }

    /* Services Section */
    .section-services {
      padding: 4rem 2rem;
      background: white;
    }

    .section-services h2 {
      text-align: center;
      margin-bottom: 0.5rem;
    }

    .section-services .services-subtitle {
      text-align: center;
      color: #6c757d;
      margin-bottom: 2rem;
    }

    .services-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .service-card {
      background: #f8f9fa;
      border-radius: 0.5rem;
      padding: 2rem;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .service-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    .service-card .service-icon {
      width: 60px;
      height: 60px;
      background: var(--primary-color, #3B82F6);
      color: white;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    .service-card h3 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }

    .service-card .description {
      color: #6c757d;
      font-size: 0.9rem;
      line-height: 1.6;
      margin-bottom: 1rem;
    }

    .service-card .price {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--primary-color, #3B82F6);
      margin-bottom: 1rem;
    }

    .service-card .service-cta {
      display: inline-block;
      padding: 0.5rem 1rem;
      background: var(--primary-color, #3B82F6);
      color: white;
      text-decoration: none;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      transition: background 0.2s;
    }

    .service-card .service-cta:hover {
      background: #2563eb;
    }

    /* Story Section */
    .section-story {
      padding: 4rem 2rem;
      background: white;
    }

    .story-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3rem;
      max-width: 1200px;
      margin: 0 auto;
      align-items: center;
    }

    .story-container.image-left {
      direction: rtl;
    }

    .story-container.image-left > * {
      direction: ltr;
    }

    .story-content h2 {
      margin-bottom: 1rem;
    }

    .story-content .story-text {
      color: #4b5563;
      line-height: 1.8;
      margin-bottom: 2rem;
    }

    .story-content .story-text p {
      margin-bottom: 1rem;
    }

    .story-highlights {
      display: flex;
      gap: 2rem;
    }

    .story-highlight {
      text-align: center;
    }

    .story-highlight .value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-color, #3B82F6);
    }

    .story-highlight .label {
      font-size: 0.875rem;
      color: #6c757d;
    }

    .story-image {
      border-radius: 0.5rem;
      overflow: hidden;
      background: #e9ecef;
      aspect-ratio: 4/3;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .story-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .story-image i {
      font-size: 4rem;
      color: #adb5bd;
    }

    /* Gallery Section */
    .section-gallery {
      padding: 4rem 2rem;
      background: #f8f9fa;
    }

    .section-gallery h2 {
      text-align: center;
      margin-bottom: 0.5rem;
    }

    .section-gallery .gallery-subtitle {
      text-align: center;
      color: #6c757d;
      margin-bottom: 2rem;
    }

    .gallery-grid {
      display: grid;
      gap: 1rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .gallery-grid.cols-2 { grid-template-columns: repeat(2, 1fr); }
    .gallery-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
    .gallery-grid.cols-4 { grid-template-columns: repeat(4, 1fr); }

    .gallery-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 0.5rem;
      overflow: hidden;
      cursor: pointer;
      background: #e9ecef;
    }

    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s;
    }

    .gallery-item:hover img {
      transform: scale(1.05);
    }

    .gallery-item .caption {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 1rem;
      background: linear-gradient(transparent, rgba(0,0,0,0.7));
      color: white;
      font-size: 0.875rem;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .gallery-item:hover .caption {
      opacity: 1;
    }

    .gallery-item .placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #adb5bd;
      font-size: 2rem;
    }

    /* Contact Form Section */
    .section-contactForm {
      padding: 4rem 2rem;
      background: white;
    }

    .contactForm-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3rem;
      max-width: 1000px;
      margin: 0 auto;
    }

    .contactForm-content h2 {
      margin-bottom: 0.5rem;
    }

    .contactForm-content .form-subtitle {
      color: #6c757d;
      margin-bottom: 2rem;
    }

    .contactForm-info {
      margin-top: 2rem;
    }

    .contactForm-info .info-item {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .contactForm-info .info-item i {
      color: var(--primary-color, #3B82F6);
      font-size: 1.25rem;
      width: 24px;
    }

    .contactForm-info .info-item span {
      color: #4b5563;
    }

    .contact-form .form-group {
      margin-bottom: 1rem;
    }

    .contact-form label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
      color: #374151;
    }

    .contact-form input,
    .contact-form textarea,
    .contact-form select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      font-size: 0.9rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .contact-form input:focus,
    .contact-form textarea:focus,
    .contact-form select:focus {
      outline: none;
      border-color: var(--primary-color, #3B82F6);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .contact-form textarea {
      resize: vertical;
      min-height: 120px;
    }

    .contact-form .submit-btn {
      width: 100%;
      padding: 0.75rem;
      background: var(--primary-color, #3B82F6);
      color: white;
      border: none;
      border-radius: 0.375rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .contact-form .submit-btn:hover {
      background: #2563eb;
    }

    /* Image picker modal */
    .image-picker-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .image-picker-modal.active {
      display: flex;
    }

    .image-picker-content {
      background: white;
      border-radius: 0.5rem;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .image-picker-header {
      padding: 1rem;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .image-picker-header h5 {
      margin: 0;
    }

    .image-picker-body {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .image-upload-zone {
      border: 2px dashed #dee2e6;
      border-radius: 0.5rem;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      margin-bottom: 1rem;
    }

    .image-upload-zone:hover,
    .image-upload-zone.dragover {
      border-color: var(--primary-color, #3B82F6);
      background: rgba(59, 130, 246, 0.05);
    }

    .image-upload-zone i {
      font-size: 2rem;
      color: #6c757d;
      margin-bottom: 0.5rem;
    }

    .site-images-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }

    .site-image-item {
      aspect-ratio: 1;
      border-radius: 0.375rem;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.2s;
    }

    .site-image-item:hover {
      border-color: var(--primary-color, #3B82F6);
    }

    .site-image-item.selected {
      border-color: var(--primary-color, #3B82F6);
    }

    .site-image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .builder-container {
        flex-direction: column;
      }

      .chat-sidebar {
        width: 100%;
        height: 50%;
      }

      .preview-area {
        height: 50%;
      }

      .story-container,
      .contactForm-container {
        grid-template-columns: 1fr;
      }

      .gallery-grid.cols-3,
      .gallery-grid.cols-4 {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>

  <script src="/static/js/bootstrap.bundle.min.js" defer></script>
</head>
<body>
  <header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="/sites">DevOpser Lite</a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="/sites">My Sites</a>
            </li>
          </ul>
          <ul class="navbar-nav">
            <% if (site) { %>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="status-badge status-<%= site.status %>">
                  <i class="fa-solid fa-circle status-icon-dot"></i>
                  <%= site.status.charAt(0).toUpperCase() + site.status.slice(1) %>
                </span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><h6 class="dropdown-header">Site Status</h6></li>
                <li><span class="dropdown-item-text small text-muted"><%= site.slug %>.devopser.io</span></li>
                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header text-danger">Danger Zone</h6></li>
                <li>
                  <button class="dropdown-item text-danger" id="delete-site-btn">
                    <i class="fa-solid fa-trash me-2"></i>Delete Site
                  </button>
                </li>
              </ul>
            </li>
            <% } %>
            <li class="nav-item">
              <a class="nav-link" href="/account">Account</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/auth/logout">Logout</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <main class="builder-container">
    <!-- Chat Sidebar -->
    <div class="chat-sidebar">
      <div class="chat-header">
        <h5><i class="fa-solid fa-comments me-2"></i>Build with AI</h5>
        <% if (site) { %>
        <small class="text-muted"><%= site.name %></small>
        <% } %>
      </div>

      <div class="chat-messages" id="chat-messages">
        <% if (!site || !site.draftConfig || !site.draftConfig.sections || site.draftConfig.sections.length === 0) { %>
        <div class="chat-message system">
          <i class="fa-solid fa-lightbulb me-1"></i>
          Describe your website and I'll create it for you! For example: "I want a landing page for a fitness app"
        </div>
        <% } else { %>
        <div class="chat-message system">
          <i class="fa-solid fa-circle-check me-1"></i>
          Your site is ready! Ask me to make changes, like "make the headline more exciting" or "add a pricing section"
        </div>
        <% } %>
      </div>

      <div class="chat-input-container">
        <textarea
          id="chat-input"
          placeholder="Describe what you want..."
          rows="3"
        ></textarea>
        <div class="chat-actions">
          <button id="send-btn" class="btn btn-primary flex-grow-1">
            <i class="fa-solid fa-paper-plane me-1"></i> Send
          </button>
          <% if (site && site.draftConfig && site.draftConfig.sections && site.draftConfig.sections.length > 0) { %>
          <button id="publish-btn" class="btn btn-success" <%= site.status === 'deploying' ? 'disabled' : '' %>>
            <i class="fa-solid fa-rocket me-1"></i> Publish
          </button>
          <% } %>
        </div>
      </div>

    </div>

    <!-- Preview Area -->
    <div class="preview-area">
      <div class="preview-header">
        <div class="preview-url">
          <i class="fa-solid fa-globe"></i>
          <% if (site) { %>
          <span><%= site.slug %>.devopser.io</span>
          <% } else { %>
          <span>your-site.devopser.io</span>
          <% } %>
        </div>
        <div class="preview-actions">
          <button class="btn btn-outline-secondary btn-sm" id="refresh-preview">
            <i class="fa-solid fa-rotate"></i>
          </button>
          <% if (site && site.status === 'published') { %>
          <a href="<%= site.publicUrl %>" target="_blank" class="btn btn-outline-primary btn-sm">
            <i class="fa-solid fa-arrow-up-right-from-square me-1"></i> View Live
          </a>
          <% } %>
        </div>
      </div>

      <div class="preview-frame-container">
        <div class="preview-frame" id="preview-frame">
          <% if (site && site.draftConfig && site.draftConfig.sections && site.draftConfig.sections.length > 0) { %>
          <!-- Render site preview -->
          <div class="site-preview" id="site-preview">
            <%
            const config = site.draftConfig;
            const primaryColor = config.theme?.primaryColor || '#3B82F6';
            const secondaryColor = config.theme?.secondaryColor || '#10B981';
            %>
            <style nonce="<%= cspNonce %>">
              .site-preview { --primary-color: <%= primaryColor %>; --secondary-color: <%= secondaryColor %>; }
            </style>

            <!-- Site Navigation -->
            <nav class="site-nav">
              <a href="#" class="site-nav-logo" data-editable data-field="siteName"><%= config.siteName || 'My Website' %></a>
              <ul class="site-nav-links">
                <% if (config.navigation && config.navigation.links) { %>
                  <% config.navigation.links.forEach((link, idx) => { %>
                  <li><a href="#" class="<%= idx === 0 ? 'active' : '' %>"><%= link.label %></a></li>
                  <% }) %>
                <% } else { %>
                  <li><a href="#" class="active">Home</a></li>
                <% } %>
              </ul>
            </nav>

            <%
              // Helper to detect dark colors for text contrast
              function isColorDarkEJS(hexColor) {
                if (!hexColor || typeof hexColor !== 'string') return false;
                const hex = hexColor.replace('#', '');
                if (hex.length !== 6 && hex.length !== 3) return false;
                let r, g, b;
                if (hex.length === 3) {
                  r = parseInt(hex[0] + hex[0], 16);
                  g = parseInt(hex[1] + hex[1], 16);
                  b = parseInt(hex[2] + hex[2], 16);
                } else {
                  r = parseInt(hex.substring(0, 2), 16);
                  g = parseInt(hex.substring(2, 4), 16);
                  b = parseInt(hex.substring(4, 6), 16);
                }
                const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                return luminance < 0.5;
              }
            %>
            <% config.sections.filter(s => s.visible !== false).sort((a,b) => a.order - b.order).forEach(section => { %>
              <% if (section.type === 'hero') { %>
              <%
                const heroBgStart = section.content.backgroundColorStart || primaryColor;
                const heroBgEnd = section.content.backgroundColorEnd || secondaryColor;
                const hasCustomBg = section.content.backgroundColorStart || section.content.backgroundColorEnd;
                const isDarkBg = hasCustomBg && (isColorDarkEJS(heroBgStart) || isColorDarkEJS(heroBgEnd));
                const heroClass = isDarkBg ? 'section-hero dark-bg' : 'section-hero';
                const ctaBtnClass = isDarkBg ? 'cta-btn cta-btn-white' : 'cta-btn';
              %>
              <div class="<%= heroClass %>" data-section-id="<%= section.id %>" data-section-type="hero" data-bg-start="<%= heroBgStart %>" data-bg-end="<%= heroBgEnd %>">
                <h1 data-editable data-field="headline"><%= section.content.headline %></h1>
                <p data-editable data-field="subheadline"><%= section.content.subheadline %></p>
                <% if (section.content.ctaText) { %>
                <a href="<%= section.content.ctaLink || '#' %>" class="<%= ctaBtnClass %>" data-editable-link data-field="ctaText" data-link-field="ctaLink"><%= section.content.ctaText %></a>
                <% } %>
              </div>
              <% } else if (section.type === 'features') { %>
              <div class="section-features" data-section-id="<%= section.id %>" data-section-type="features">
                <h2 data-editable data-field="title"><%= section.content.title %></h2>
                <div class="features-grid">
                  <% (section.content.items || []).forEach((item, itemIndex) => { %>
                  <div class="feature-item" data-item-index="<%= itemIndex %>">
                    <div class="feature-icon" data-editable-icon data-field="items.<%= itemIndex %>.icon" data-current-icon="<%= item.icon || 'star' %>"><i class="fa-solid fa-<%= item.icon || 'star' %>"></i></div>
                    <h3 data-editable data-field="items.<%= itemIndex %>.title"><%= item.title %></h3>
                    <p data-editable data-field="items.<%= itemIndex %>.description"><%= item.description %></p>
                  </div>
                  <% }) %>
                </div>
              </div>
              <% } else if (section.type === 'about') { %>
              <div class="section-about" data-section-id="<%= section.id %>" data-section-type="about">
                <h2 data-editable data-field="title"><%= section.content.title %></h2>
                <p data-editable data-field="content"><%= section.content.content %></p>
              </div>
              <% } else if (section.type === 'testimonials') { %>
              <div class="section-testimonials" data-section-id="<%= section.id %>" data-section-type="testimonials">
                <h2 data-editable data-field="title"><%= section.content.title || 'Testimonials' %></h2>
                <div class="testimonials-grid">
                  <% (section.content.items || []).forEach((item, itemIndex) => { %>
                  <div class="testimonial-item" data-item-index="<%= itemIndex %>">
                    <p class="testimonial-quote" data-editable data-field="items.<%= itemIndex %>.quote">"<%= item.quote %>"</p>
                    <p class="testimonial-author" data-editable data-field="items.<%= itemIndex %>.author"><%= item.author %></p>
                    <% if (item.role) { %>
                    <p class="testimonial-role" data-editable data-field="items.<%= itemIndex %>.role"><%= item.role %></p>
                    <% } %>
                  </div>
                  <% }) %>
                </div>
              </div>
              <% } else if (section.type === 'pricing') { %>
              <div class="section-pricing" data-section-id="<%= section.id %>" data-section-type="pricing">
                <h2 data-editable data-field="title"><%= section.content.title || 'Pricing' %></h2>
                <% if (section.content.subtitle) { %>
                <p class="pricing-subtitle" data-editable data-field="subtitle"><%= section.content.subtitle %></p>
                <% } %>
                <div class="pricing-grid">
                  <% (section.content.items || []).forEach((plan, planIndex) => { %>
                  <div class="pricing-item<%= plan.highlighted ? ' highlighted' : '' %>" data-item-index="<%= planIndex %>">
                    <h3 class="plan-name" data-editable data-field="items.<%= planIndex %>.name"><%= plan.name %></h3>
                    <div class="plan-price">
                      <span data-editable data-field="items.<%= planIndex %>.price"><%= plan.price %></span>
                      <span class="period" data-editable data-field="items.<%= planIndex %>.period"><%= plan.period || '' %></span>
                    </div>
                    <ul class="plan-features">
                      <% (plan.features || []).forEach((feature, featureIndex) => { %>
                      <li data-editable data-field="items.<%= planIndex %>.features.<%= featureIndex %>"><%= feature %></li>
                      <% }) %>
                    </ul>
                    <% if (plan.ctaText) { %>
                    <a href="<%= plan.ctaLink || '#' %>" class="pricing-cta" data-editable-link data-field="items.<%= planIndex %>.ctaText" data-link-field="items.<%= planIndex %>.ctaLink"><%= plan.ctaText %></a>
                    <% } %>
                  </div>
                  <% }) %>
                </div>
              </div>
              <% } else if (section.type === 'contact') { %>
              <div class="section-contact" data-section-id="<%= section.id %>" data-section-type="contact">
                <h2 data-editable data-field="title"><%= section.content.title %></h2>
                <p data-editable data-field="subtitle"><%= section.content.subtitle %></p>
                <% if (section.content.email) { %>
                <p><i class="fa-solid fa-envelope me-2"></i><span data-editable data-field="email"><%= section.content.email %></span></p>
                <% } %>
              </div>
              <% } else if (section.type === 'team') { %>
              <div class="section-team" data-section-id="<%= section.id %>" data-section-type="team">
                <h2 data-editable data-field="title"><%= section.content.title || 'Meet Our Team' %></h2>
                <% if (section.content.subtitle) { %>
                <p class="team-subtitle" data-editable data-field="subtitle"><%= section.content.subtitle %></p>
                <% } %>
                <div class="team-grid">
                  <% (section.content.members || []).forEach((member, memberIndex) => { %>
                  <div class="team-member" data-item-index="<%= memberIndex %>">
                    <div class="team-member-photo" data-editable-image data-field="members.<%= memberIndex %>.photo">
                      <% if (member.photo) { %>
                      <img src="<%= member.photo %>" alt="<%= member.name %>">
                      <% } else { %>
                      <i class="fa-solid fa-user"></i>
                      <% } %>
                    </div>
                    <h3 data-editable data-field="members.<%= memberIndex %>.name"><%= member.name || '' %></h3>
                    <p class="role" data-editable data-field="members.<%= memberIndex %>.role"><%= member.role || '' %></p>
                    <% if (member.bio) { %>
                    <p class="bio" data-editable data-field="members.<%= memberIndex %>.bio"><%= member.bio %></p>
                    <% } %>
                  </div>
                  <% }) %>
                </div>
              </div>
              <% } else if (section.type === 'services') { %>
              <div class="section-services" data-section-id="<%= section.id %>" data-section-type="services">
                <h2 data-editable data-field="title"><%= section.content.title || 'Our Services' %></h2>
                <% if (section.content.subtitle) { %>
                <p class="services-subtitle" data-editable data-field="subtitle"><%= section.content.subtitle %></p>
                <% } %>
                <div class="services-grid">
                  <% (section.content.items || []).forEach((item, itemIndex) => { %>
                  <div class="service-card" data-item-index="<%= itemIndex %>">
                    <% if (item.icon) { %>
                    <div class="service-icon" data-editable-icon data-field="items.<%= itemIndex %>.icon" data-current-icon="<%= item.icon %>"><i class="fa-solid fa-<%= item.icon %>"></i></div>
                    <% } %>
                    <h3 data-editable data-field="items.<%= itemIndex %>.title"><%= item.title || '' %></h3>
                    <p class="description" data-editable data-field="items.<%= itemIndex %>.description"><%= item.description || '' %></p>
                    <% if (item.price) { %>
                    <p class="price" data-editable data-field="items.<%= itemIndex %>.price"><%= item.price %></p>
                    <% } %>
                    <% if (item.ctaText) { %>
                    <a href="<%= item.ctaLink || '#' %>" class="service-cta" data-editable-link data-field="items.<%= itemIndex %>.ctaText" data-link-field="items.<%= itemIndex %>.ctaLink"><%= item.ctaText %></a>
                    <% } %>
                  </div>
                  <% }) %>
                </div>
              </div>
              <% } else if (section.type === 'story') { %>
              <div class="section-story" data-section-id="<%= section.id %>" data-section-type="story">
                <div class="story-container<%= section.content.imagePosition === 'left' ? ' image-left' : '' %>">
                  <div class="story-content">
                    <h2 data-editable data-field="title"><%= section.content.title || 'Our Story' %></h2>
                    <div class="story-text" data-editable data-field="content"><%- section.content.content || '' %></div>
                    <% if (section.content.highlights && section.content.highlights.length > 0) { %>
                    <div class="story-highlights">
                      <% section.content.highlights.forEach((highlight, hIndex) => { %>
                      <div class="story-highlight">
                        <div class="value" data-editable data-field="highlights.<%= hIndex %>.value"><%= highlight.value || '' %></div>
                        <div class="label" data-editable data-field="highlights.<%= hIndex %>.label"><%= highlight.label || '' %></div>
                      </div>
                      <% }) %>
                    </div>
                    <% } %>
                  </div>
                  <div class="story-image" data-editable-image data-field="image">
                    <% if (section.content.image) { %>
                    <img src="<%= section.content.image %>" alt="<%= section.content.title || 'Our Story' %>">
                    <% } else { %>
                    <i class="fa-solid fa-image"></i>
                    <% } %>
                  </div>
                </div>
              </div>
              <% } else if (section.type === 'gallery') { %>
              <div class="section-gallery" data-section-id="<%= section.id %>" data-section-type="gallery">
                <% if (section.content.title) { %>
                <h2 data-editable data-field="title"><%= section.content.title %></h2>
                <% } %>
                <% if (section.content.subtitle) { %>
                <p class="gallery-subtitle" data-editable data-field="subtitle"><%= section.content.subtitle %></p>
                <% } %>
                <div class="gallery-grid cols-<%= section.content.columns || 3 %>">
                  <% (section.content.images || []).forEach((image, imgIndex) => { %>
                  <div class="gallery-item" data-item-index="<%= imgIndex %>" data-editable-image data-field="images.<%= imgIndex %>.url">
                    <% if (image.url) { %>
                    <img src="<%= image.url %>" alt="<%= image.alt || image.caption || '' %>">
                    <% if (image.caption) { %>
                    <div class="caption"><%= image.caption %></div>
                    <% } %>
                    <% } else { %>
                    <div class="placeholder"><i class="fa-solid fa-image"></i></div>
                    <% } %>
                  </div>
                  <% }) %>
                </div>
              </div>
              <% } else if (section.type === 'contactForm') { %>
              <div class="section-contactForm" data-section-id="<%= section.id %>" data-section-type="contactForm">
                <div class="contactForm-container">
                  <div class="contactForm-content">
                    <h2 data-editable data-field="title"><%= section.content.title || 'Get in Touch' %></h2>
                    <% if (section.content.subtitle) { %>
                    <p class="form-subtitle" data-editable data-field="subtitle"><%= section.content.subtitle %></p>
                    <% } %>
                    <% if (section.content.contactInfo) { %>
                    <div class="contactForm-info">
                      <% if (section.content.contactInfo.email) { %>
                      <div class="info-item"><i class="fa-solid fa-envelope"></i><span data-editable data-field="contactInfo.email"><%= section.content.contactInfo.email %></span></div>
                      <% } %>
                      <% if (section.content.contactInfo.phone) { %>
                      <div class="info-item"><i class="fa-solid fa-phone"></i><span data-editable data-field="contactInfo.phone"><%= section.content.contactInfo.phone %></span></div>
                      <% } %>
                      <% if (section.content.contactInfo.address) { %>
                      <div class="info-item"><i class="fa-solid fa-location-dot"></i><span data-editable data-field="contactInfo.address"><%= section.content.contactInfo.address %></span></div>
                      <% } %>
                      <% if (section.content.contactInfo.hours) { %>
                      <div class="info-item"><i class="fa-solid fa-clock"></i><span data-editable data-field="contactInfo.hours"><%= section.content.contactInfo.hours %></span></div>
                      <% } %>
                    </div>
                    <% } %>
                  </div>
                  <div class="contact-form">
                    <% (section.content.fields || []).forEach(field => { %>
                    <div class="form-group">
                      <label><%= field.label || field.name %><%= field.required ? ' *' : '' %></label>
                      <% if (field.type === 'textarea') { %>
                      <textarea name="<%= field.name %>" placeholder="<%= field.placeholder || '' %>"<%= field.required ? ' required' : '' %>></textarea>
                      <% } else if (field.type === 'select' && field.options) { %>
                      <select name="<%= field.name %>"<%= field.required ? ' required' : '' %>>
                        <option value=""><%= field.placeholder || 'Select...' %></option>
                        <% field.options.forEach(opt => { %>
                        <option value="<%= opt %>"><%= opt %></option>
                        <% }) %>
                      </select>
                      <% } else { %>
                      <input type="<%= field.type || 'text' %>" name="<%= field.name %>" placeholder="<%= field.placeholder || '' %>"<%= field.required ? ' required' : '' %>>
                      <% } %>
                    </div>
                    <% }) %>
                    <button type="submit" class="submit-btn"><%= section.content.submitButtonText || 'Send Message' %></button>
                  </div>
                </div>
              </div>
              <% } else if (section.type === 'footer') { %>
              <div class="section-footer" data-section-id="<%= section.id %>" data-section-type="footer">
                <p data-editable data-field="copyright"><%= section.content.copyright || 'Â© ' + new Date().getFullYear() + ' ' + (section.content.companyName || config.siteName) %></p>
              </div>
              <% } %>
            <% }) %>
          </div>
          <% } else { %>
          <div class="empty-state">
            <i class="fa-solid fa-palette"></i>
            <h5>No preview yet</h5>
            <p>Describe your website in the chat to get started!</p>
          </div>
          <% } %>
        </div>
      </div>
    </div>
  </main>

  <!-- Link/Button Edit Popup -->
  <div class="link-edit-popup" id="linkEditPopup">
    <div class="popup-title">Edit Button</div>
    <div class="form-group">
      <label>Button Text</label>
      <input type="text" id="linkEditText" placeholder="Button text">
    </div>
    <div class="form-group">
      <label>Link URL</label>
      <input type="text" id="linkEditUrl" placeholder="https://...">
    </div>
    <div class="btn-group">
      <button type="button" class="btn-save" id="linkEditSaveBtn">Save</button>
      <button type="button" class="btn-cancel" id="linkEditCancelBtn">Cancel</button>
    </div>
  </div>

  <!-- Icon Picker Popup -->
  <div class="icon-picker-popup" id="iconPickerPopup">
    <div class="popup-title">Choose Icon</div>
    <div class="icon-picker-grid" id="iconPickerGrid">
      <!-- Icons will be populated by JavaScript -->
    </div>
  </div>

  <!-- Image Picker Modal -->
  <div class="image-picker-modal" id="imagePickerModal">
    <div class="image-picker-content">
      <div class="image-picker-header">
        <h5>Choose Image</h5>
        <button type="button" class="btn-close" id="closeImagePicker"></button>
      </div>
      <div class="image-picker-body">
        <div class="image-upload-zone" id="imageUploadZone">
          <i class="fa-solid fa-cloud-arrow-up"></i>
          <p>Drag & drop an image or click to upload</p>
          <input type="file" id="imageFileInput" accept="image/*" hidden>
        </div>
        <div id="uploadProgress" class="mb-3" style="display: none;">
          <div class="progress">
            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
          </div>
        </div>
        <h6 class="mt-3 mb-2">Your Images</h6>
        <div class="site-images-grid" id="siteImagesGrid">
          <!-- Images will be populated by JavaScript -->
        </div>
        <div id="noImagesMessage" class="text-muted text-center py-3">
          No images uploaded yet
        </div>
      </div>
    </div>
  </div>

  <script nonce="<%= cspNonce %>">
    // Site data from server
    const siteId = '<%= site ? site.id : "" %>';
    const siteData = <%- site ? JSON.stringify(site) : 'null' %>;

    // Chat functionality
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const publishBtn = document.getElementById('publish-btn');
    const previewFrame = document.getElementById('preview-frame');
    const refreshPreviewBtn = document.getElementById('refresh-preview');

    let chatHistory = [];
    let isProcessing = false;

    // Simple markdown formatter for chat messages
    function formatMarkdown(text) {
      if (!text) return '';

      // Escape HTML first
      let html = escapeHtml(text);

      // Code blocks (```)
      html = html.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>');

      // Inline code (`)
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

      // Bold (**text** or __text__)
      html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/__([^_]+)__/g, '<strong>$1</strong>');

      // Italic (*text* or _text_)
      html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      html = html.replace(/_([^_]+)_/g, '<em>$1</em>');

      // Headers (## Header)
      html = html.replace(/^### (.+)$/gm, '<h6>$1</h6>');
      html = html.replace(/^## (.+)$/gm, '<h5>$1</h5>');
      html = html.replace(/^# (.+)$/gm, '<h4>$1</h4>');

      // Bullet lists (- item or * item at start of line)
      html = html.replace(/^[\-\*] (.+)$/gm, '<li>$1</li>');
      html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

      // Numbered lists (1. item)
      html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');

      // Line breaks
      html = html.replace(/\n/g, '<br>');

      // Clean up extra breaks around block elements
      html = html.replace(/<br>(<\/?(?:ul|ol|li|h[1-6]|pre|code)>)/g, '$1');
      html = html.replace(/(<\/?(?:ul|ol|li|h[1-6]|pre|code)>)<br>/g, '$1');

      return html;
    }

    // Add message to chat
    function addMessage(role, content) {
      const div = document.createElement('div');
      div.className = `chat-message ${role}`;

      if (role === 'assistant') {
        // Format markdown for assistant messages
        div.innerHTML = formatMarkdown(content);
      } else {
        div.textContent = content;
      }

      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Add tools used indicator
    function addToolsUsedMessage(toolNames) {
      const div = document.createElement('div');
      div.className = 'chat-message tools-used';
      div.innerHTML = '<i class="fa-solid fa-screwdriver-wrench me-1"></i> Used: ' + escapeHtml(toolNames);
      chatMessages.appendChild(div);
    }

    // Send chat message
    async function sendMessage() {
      const message = chatInput.value.trim();
      if (!message || isProcessing || !siteId) return;

      isProcessing = true;
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Processing...';

      // Add user message to chat
      addMessage('user', message);
      chatInput.value = '';

      // Add to history
      chatHistory.push({ role: 'user', content: message });

      try {
        const response = await fetch(`/api/sites/${siteId}/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'same-origin',
          body: JSON.stringify({
            message,
            history: chatHistory
          })
        });

        const data = await response.json();

        if (data.success) {
          // Show tools used if any
          if (data.toolsUsed && data.toolsUsed.length > 0) {
            const toolNames = data.toolsUsed.map(t => t.name.replace(/_/g, ' ')).join(', ');
            addToolsUsedMessage(toolNames);
          }

          // Add AI response to chat
          addMessage('assistant', data.message);
          chatHistory.push({ role: 'assistant', content: data.message });

          // Refresh preview if config changed
          if (data.siteConfig) {
            console.log('[Builder] Refreshing preview with config:', JSON.stringify(data.siteConfig.sections?.find(s => s.type === 'hero')?.content, null, 2));
            refreshPreview(data.siteConfig);
            // Update local siteData
            siteData.draftConfig = data.siteConfig;

            // Show publish button if we now have content
            if (data.siteConfig.sections && data.siteConfig.sections.length > 0) {
              if (!publishBtn) {
                location.reload(); // Reload to show publish button
              }
            }
          }
        } else {
          addMessage('system', 'Error: ' + (data.error || 'Something went wrong'));
        }
      } catch (error) {
        console.error('Chat error:', error);
        addMessage('system', 'Error: Failed to send message. Please try again.');
      }

      isProcessing = false;
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<i class="fa-solid fa-paper-plane me-1"></i> Send';
    }

    // Helper to determine if a hex color is dark (for text contrast)
    function isColorDark(hexColor) {
      if (!hexColor || typeof hexColor !== 'string') return false;
      var hex = hexColor.replace('#', '');
      if (hex.length !== 6 && hex.length !== 3) return false;
      var r, g, b;
      if (hex.length === 3) {
        r = parseInt(hex[0] + hex[0], 16);
        g = parseInt(hex[1] + hex[1], 16);
        b = parseInt(hex[2] + hex[2], 16);
      } else {
        r = parseInt(hex.substring(0, 2), 16);
        g = parseInt(hex.substring(2, 4), 16);
        b = parseInt(hex.substring(4, 6), 16);
      }
      var luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      return luminance < 0.5;
    }

    // Refresh preview with new config
    function refreshPreview(config) {
      console.log('[Builder] refreshPreview called');
      const primaryColor = config.theme?.primaryColor || '#3B82F6';
      const secondaryColor = config.theme?.secondaryColor || '#10B981';

      let html = '<div class="site-preview" id="sitePreviewContent">';

      const sections = (config.sections || [])
        .filter(s => s.visible !== false)
        .sort((a, b) => a.order - b.order);

      sections.forEach(function(section, sectionIndex) {
        var sectionId = section.id;
        if (section.type === 'hero') {
          // Support custom hero background colors
          var heroBgStart = section.content.backgroundColorStart || primaryColor;
          var heroBgEnd = section.content.backgroundColorEnd || secondaryColor;
          var hasCustomBg = section.content.backgroundColorStart || section.content.backgroundColorEnd;
          var isDark = hasCustomBg && (isColorDark(heroBgStart) || isColorDark(heroBgEnd));
          var heroClass = isDark ? 'section-hero dark-bg' : 'section-hero';
          console.log('[Builder] Hero rendering:', { heroBgStart, heroBgEnd, hasCustomBg, isDark });
          // Use data attributes for colors and editing - CSS will be applied via JS after innerHTML
          html += '<div class="' + heroClass + '" data-section-id="' + sectionId + '" data-section-type="hero" data-bg-start="' + heroBgStart + '" data-bg-end="' + heroBgEnd + '">';
          html += '<h1 data-editable data-field="headline">' + escapeHtml(section.content.headline || '') + '</h1>';
          html += '<p data-editable data-field="subheadline">' + escapeHtml(section.content.subheadline || '') + '</p>';
          if (section.content.ctaText) {
            var ctaBtnClass = isDark ? 'cta-btn cta-btn-white' : 'cta-btn';
            html += '<a href="' + escapeHtml(section.content.ctaLink || '#') + '" class="' + ctaBtnClass + '" data-editable-link data-field="ctaText" data-link-field="ctaLink">' + escapeHtml(section.content.ctaText) + '</a>';
          }
          html += '</div>';
        } else if (section.type === 'features') {
          html += '<div class="section-features" data-section-id="' + sectionId + '" data-section-type="features">';
          html += '<h2 data-editable data-field="title">' + escapeHtml(section.content.title || '') + '</h2>';
          html += '<div class="features-grid">';
          (section.content.items || []).forEach(function(item, itemIndex) {
            var iconName = item.icon || 'star';
            html += '<div class="feature-item" data-item-index="' + itemIndex + '">';
            html += '<div class="feature-icon" data-editable-icon data-field="items.' + itemIndex + '.icon" data-current-icon="' + escapeHtml(iconName) + '"><i class="fa-solid fa-' + escapeHtml(iconName) + '"></i></div>';
            html += '<h3 data-editable data-field="items.' + itemIndex + '.title">' + escapeHtml(item.title || '') + '</h3>';
            html += '<p data-editable data-field="items.' + itemIndex + '.description">' + escapeHtml(item.description || '') + '</p>';
            html += '</div>';
          });
          html += '</div></div>';
        } else if (section.type === 'about') {
          html += '<div class="section-about" data-section-id="' + sectionId + '" data-section-type="about">';
          html += '<h2 data-editable data-field="title">' + escapeHtml(section.content.title || '') + '</h2>';
          html += '<p data-editable data-field="content">' + escapeHtml(section.content.content || '') + '</p>';
          html += '</div>';
        } else if (section.type === 'testimonials') {
          html += '<div class="section-testimonials" data-section-id="' + sectionId + '" data-section-type="testimonials">';
          html += '<h2 data-editable data-field="title">' + escapeHtml(section.content.title || 'Testimonials') + '</h2>';
          html += '<div class="testimonials-grid">';
          (section.content.items || []).forEach(function(item, itemIndex) {
            html += '<div class="testimonial-item" data-item-index="' + itemIndex + '">';
            html += '<p class="testimonial-quote" data-editable data-field="items.' + itemIndex + '.quote">"' + escapeHtml(item.quote || '') + '"</p>';
            html += '<p class="testimonial-author" data-editable data-field="items.' + itemIndex + '.author">' + escapeHtml(item.author || '') + '</p>';
            if (item.role) {
              html += '<p class="testimonial-role" data-editable data-field="items.' + itemIndex + '.role">' + escapeHtml(item.role) + '</p>';
            }
            html += '</div>';
          });
          html += '</div></div>';
        } else if (section.type === 'pricing') {
          html += '<div class="section-pricing" data-section-id="' + sectionId + '" data-section-type="pricing">';
          html += '<h2 data-editable data-field="title">' + escapeHtml(section.content.title || 'Pricing') + '</h2>';
          if (section.content.subtitle) {
            html += '<p class="pricing-subtitle" data-editable data-field="subtitle">' + escapeHtml(section.content.subtitle) + '</p>';
          }
          html += '<div class="pricing-grid">';
          (section.content.items || []).forEach(function(item, itemIndex) {
            var itemClass = item.highlighted ? 'pricing-item highlighted' : 'pricing-item';
            html += '<div class="' + itemClass + '" data-item-index="' + itemIndex + '">';
            html += '<p class="pricing-name" data-editable data-field="items.' + itemIndex + '.name">' + escapeHtml(item.name || '') + '</p>';
            html += '<p><span class="pricing-price" data-editable data-field="items.' + itemIndex + '.price">' + escapeHtml(item.price || '') + '</span>';
            if (item.period) {
              html += '<span class="pricing-period">' + escapeHtml(item.period) + '</span>';
            }
            html += '</p>';
            if (item.features && item.features.length > 0) {
              html += '<ul class="pricing-features" data-editable-list data-field="items.' + itemIndex + '.features">';
              item.features.forEach(function(feature, featureIndex) {
                html += '<li data-editable-list-item data-list-index="' + featureIndex + '">' + escapeHtml(feature) + '</li>';
              });
              html += '</ul>';
            }
            if (item.ctaText) {
              html += '<a href="' + escapeHtml(item.ctaLink || '#') + '" class="pricing-cta" data-editable-link data-field="items.' + itemIndex + '.ctaText" data-link-field="items.' + itemIndex + '.ctaLink">' + escapeHtml(item.ctaText) + '</a>';
            }
            html += '</div>';
          });
          html += '</div></div>';
        } else if (section.type === 'contact') {
          html += '<div class="section-contact" data-section-id="' + sectionId + '" data-section-type="contact">';
          html += '<h2 data-editable data-field="title">' + escapeHtml(section.content.title || '') + '</h2>';
          html += '<p data-editable data-field="subtitle">' + escapeHtml(section.content.subtitle || '') + '</p>';
          if (section.content.email) {
            html += '<p><i class="fa-solid fa-envelope me-2"></i><span data-editable data-field="email">' + escapeHtml(section.content.email) + '</span></p>';
          }
          html += '</div>';
        } else if (section.type === 'team') {
          html += '<div class="section-team" data-section-id="' + sectionId + '" data-section-type="team">';
          html += '<h2 data-editable data-field="title">' + escapeHtml(section.content.title || 'Meet Our Team') + '</h2>';
          if (section.content.subtitle) {
            html += '<p class="team-subtitle" data-editable data-field="subtitle">' + escapeHtml(section.content.subtitle) + '</p>';
          }
          html += '<div class="team-grid">';
          (section.content.members || []).forEach(function(member, memberIndex) {
            html += '<div class="team-member" data-item-index="' + memberIndex + '">';
            html += '<div class="team-member-photo" data-editable-image data-field="members.' + memberIndex + '.photo">';
            if (member.photo) {
              html += '<img src="' + escapeHtml(member.photo) + '" alt="' + escapeHtml(member.name) + '">';
            } else {
              html += '<i class="fa-solid fa-user"></i>';
            }
            html += '</div>';
            html += '<h3 data-editable data-field="members.' + memberIndex + '.name">' + escapeHtml(member.name || '') + '</h3>';
            html += '<p class="role" data-editable data-field="members.' + memberIndex + '.role">' + escapeHtml(member.role || '') + '</p>';
            if (member.bio) {
              html += '<p class="bio" data-editable data-field="members.' + memberIndex + '.bio">' + escapeHtml(member.bio) + '</p>';
            }
            html += '</div>';
          });
          html += '</div></div>';
        } else if (section.type === 'services') {
          html += '<div class="section-services" data-section-id="' + sectionId + '" data-section-type="services">';
          html += '<h2 data-editable data-field="title">' + escapeHtml(section.content.title || 'Our Services') + '</h2>';
          if (section.content.subtitle) {
            html += '<p class="services-subtitle" data-editable data-field="subtitle">' + escapeHtml(section.content.subtitle) + '</p>';
          }
          html += '<div class="services-grid">';
          (section.content.items || []).forEach(function(item, itemIndex) {
            html += '<div class="service-card" data-item-index="' + itemIndex + '">';
            if (item.icon) {
              html += '<div class="service-icon" data-editable-icon data-field="items.' + itemIndex + '.icon" data-current-icon="' + escapeHtml(item.icon) + '"><i class="fa-solid fa-' + escapeHtml(item.icon) + '"></i></div>';
            }
            html += '<h3 data-editable data-field="items.' + itemIndex + '.title">' + escapeHtml(item.title || '') + '</h3>';
            html += '<p class="description" data-editable data-field="items.' + itemIndex + '.description">' + escapeHtml(item.description || '') + '</p>';
            if (item.price) {
              html += '<p class="price" data-editable data-field="items.' + itemIndex + '.price">' + escapeHtml(item.price) + '</p>';
            }
            if (item.ctaText) {
              html += '<a href="' + escapeHtml(item.ctaLink || '#') + '" class="service-cta" data-editable-link data-field="items.' + itemIndex + '.ctaText" data-link-field="items.' + itemIndex + '.ctaLink">' + escapeHtml(item.ctaText) + '</a>';
            }
            html += '</div>';
          });
          html += '</div></div>';
        } else if (section.type === 'story') {
          var imagePos = section.content.imagePosition || 'right';
          var containerClass = imagePos === 'left' ? 'story-container image-left' : 'story-container';
          html += '<div class="section-story" data-section-id="' + sectionId + '" data-section-type="story">';
          html += '<div class="' + containerClass + '">';
          html += '<div class="story-content">';
          html += '<h2 data-editable data-field="title">' + escapeHtml(section.content.title || 'Our Story') + '</h2>';
          html += '<div class="story-text" data-editable data-field="content">' + (section.content.content || '') + '</div>';
          if (section.content.highlights && section.content.highlights.length > 0) {
            html += '<div class="story-highlights">';
            section.content.highlights.forEach(function(highlight, hIndex) {
              html += '<div class="story-highlight">';
              html += '<div class="value" data-editable data-field="highlights.' + hIndex + '.value">' + escapeHtml(highlight.value || '') + '</div>';
              html += '<div class="label" data-editable data-field="highlights.' + hIndex + '.label">' + escapeHtml(highlight.label || '') + '</div>';
              html += '</div>';
            });
            html += '</div>';
          }
          html += '</div>';
          html += '<div class="story-image" data-editable-image data-field="image">';
          if (section.content.image) {
            html += '<img src="' + escapeHtml(section.content.image) + '" alt="' + escapeHtml(section.content.title || 'Our Story') + '">';
          } else {
            html += '<i class="fa-solid fa-image"></i>';
          }
          html += '</div>';
          html += '</div></div>';
        } else if (section.type === 'gallery') {
          var cols = section.content.columns || 3;
          html += '<div class="section-gallery" data-section-id="' + sectionId + '" data-section-type="gallery">';
          if (section.content.title) {
            html += '<h2 data-editable data-field="title">' + escapeHtml(section.content.title) + '</h2>';
          }
          if (section.content.subtitle) {
            html += '<p class="gallery-subtitle" data-editable data-field="subtitle">' + escapeHtml(section.content.subtitle) + '</p>';
          }
          html += '<div class="gallery-grid cols-' + cols + '">';
          (section.content.images || []).forEach(function(image, imgIndex) {
            html += '<div class="gallery-item" data-item-index="' + imgIndex + '" data-editable-image data-field="images.' + imgIndex + '.url">';
            if (image.url) {
              html += '<img src="' + escapeHtml(image.url) + '" alt="' + escapeHtml(image.alt || image.caption || '') + '">';
              if (image.caption) {
                html += '<div class="caption">' + escapeHtml(image.caption) + '</div>';
              }
            } else {
              html += '<div class="placeholder"><i class="fa-solid fa-image"></i></div>';
            }
            html += '</div>';
          });
          html += '</div></div>';
        } else if (section.type === 'contactForm') {
          html += '<div class="section-contactForm" data-section-id="' + sectionId + '" data-section-type="contactForm">';
          html += '<div class="contactForm-container">';
          html += '<div class="contactForm-content">';
          html += '<h2 data-editable data-field="title">' + escapeHtml(section.content.title || 'Get in Touch') + '</h2>';
          if (section.content.subtitle) {
            html += '<p class="form-subtitle" data-editable data-field="subtitle">' + escapeHtml(section.content.subtitle) + '</p>';
          }
          if (section.content.contactInfo) {
            var info = section.content.contactInfo;
            html += '<div class="contactForm-info">';
            if (info.email) {
              html += '<div class="info-item"><i class="fa-solid fa-envelope"></i><span data-editable data-field="contactInfo.email">' + escapeHtml(info.email) + '</span></div>';
            }
            if (info.phone) {
              html += '<div class="info-item"><i class="fa-solid fa-phone"></i><span data-editable data-field="contactInfo.phone">' + escapeHtml(info.phone) + '</span></div>';
            }
            if (info.address) {
              html += '<div class="info-item"><i class="fa-solid fa-location-dot"></i><span data-editable data-field="contactInfo.address">' + escapeHtml(info.address) + '</span></div>';
            }
            if (info.hours) {
              html += '<div class="info-item"><i class="fa-solid fa-clock"></i><span data-editable data-field="contactInfo.hours">' + escapeHtml(info.hours) + '</span></div>';
            }
            html += '</div>';
          }
          html += '</div>';
          html += '<div class="contact-form">';
          (section.content.fields || []).forEach(function(field) {
            html += '<div class="form-group">';
            html += '<label>' + escapeHtml(field.label || field.name) + (field.required ? ' *' : '') + '</label>';
            if (field.type === 'textarea') {
              html += '<textarea name="' + escapeHtml(field.name) + '" placeholder="' + escapeHtml(field.placeholder || '') + '"' + (field.required ? ' required' : '') + '></textarea>';
            } else if (field.type === 'select' && field.options) {
              html += '<select name="' + escapeHtml(field.name) + '"' + (field.required ? ' required' : '') + '>';
              html += '<option value="">' + escapeHtml(field.placeholder || 'Select...') + '</option>';
              field.options.forEach(function(opt) {
                html += '<option value="' + escapeHtml(opt) + '">' + escapeHtml(opt) + '</option>';
              });
              html += '</select>';
            } else {
              html += '<input type="' + escapeHtml(field.type || 'text') + '" name="' + escapeHtml(field.name) + '" placeholder="' + escapeHtml(field.placeholder || '') + '"' + (field.required ? ' required' : '') + '>';
            }
            html += '</div>';
          });
          html += '<button type="submit" class="submit-btn">' + escapeHtml(section.content.submitButtonText || 'Send Message') + '</button>';
          html += '</div>';
          html += '</div></div>';
        } else if (section.type === 'footer') {
          var copyright = section.content.copyright || ('Â© ' + new Date().getFullYear() + ' ' + (section.content.companyName || config.siteName || ''));
          html += '<div class="section-footer" data-section-id="' + sectionId + '" data-section-type="footer">';
          html += '<p data-editable data-field="copyright">' + escapeHtml(copyright) + '</p>';
          html += '</div>';
        }
      });

      html += '</div>';

      if (sections.length > 0) {
        previewFrame.innerHTML = html;
        // Set CSS variables via JavaScript to avoid inline style CSP violation
        var previewEl = document.getElementById('sitePreviewContent');
        if (previewEl) {
          previewEl.style.setProperty('--primary-color', primaryColor);
          previewEl.style.setProperty('--secondary-color', secondaryColor);
        }
        // Apply hero background colors from data attributes (CSP-compliant)
        var heroEl = previewFrame.querySelector('.section-hero');
        if (heroEl) {
          var bgStart = heroEl.getAttribute('data-bg-start');
          var bgEnd = heroEl.getAttribute('data-bg-end');
          if (bgStart && bgEnd) {
            heroEl.style.background = 'linear-gradient(135deg, ' + bgStart + ', ' + bgEnd + ')';
            console.log('[Builder] Applied hero background:', bgStart, '->', bgEnd);
          }
        }
        // Initialize editable elements
        initEditableElements();
      } else {
        previewFrame.innerHTML = '<div class="empty-state"><i class="fa-solid fa-palette"></i><h5>No preview yet</h5><p>Describe your website in the chat to get started!</p></div>';
      }
    }

    // ============================================
    // WYSIWYG INLINE EDITING
    // ============================================

    var currentEditElement = null;
    var currentLinkElement = null;
    var originalContent = '';

    // Initialize editable elements with event listeners
    function initEditableElements() {
      // Text editable elements
      var editables = previewFrame.querySelectorAll('[data-editable]');
      editables.forEach(function(el) {
        el.addEventListener('click', handleEditableClick);
        el.addEventListener('blur', handleEditableBlur);
        el.addEventListener('keydown', handleEditableKeydown);
      });

      // Link/button editable elements
      var links = previewFrame.querySelectorAll('[data-editable-link]');
      links.forEach(function(el) {
        el.addEventListener('click', handleLinkClick);
      });

      // Icon editable elements
      var icons = previewFrame.querySelectorAll('[data-editable-icon]');
      icons.forEach(function(el) {
        el.addEventListener('click', handleIconClick);
      });

      // Editable list items (pricing features, etc.)
      var listItems = previewFrame.querySelectorAll('[data-editable-list-item]');
      listItems.forEach(function(el) {
        el.addEventListener('click', handleListItemClick);
        el.addEventListener('blur', handleListItemBlur);
        el.addEventListener('keydown', handleListItemKeydown);
      });

      // Add delete buttons and add-item buttons to lists
      var lists = previewFrame.querySelectorAll('[data-editable-list]');
      lists.forEach(function(list) {
        initEditableList(list);
      });

      // Initialize icon picker grid
      initIconPicker();

      // Initialize drag and drop for section reordering
      initDragAndDrop();
    }

    // Handle click on editable text element
    function handleEditableClick(e) {
      e.preventDefault();
      e.stopPropagation();

      var el = e.target;
      if (el.getAttribute('contenteditable') === 'true') return;

      // Store original content for cancel
      originalContent = el.textContent;
      currentEditElement = el;

      // Make editable
      el.setAttribute('contenteditable', 'true');
      el.focus();

      // Select all text
      var range = document.createRange();
      range.selectNodeContents(el);
      var sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    }

    // Handle blur (save changes)
    function handleEditableBlur(e) {
      var el = e.target;
      if (el.getAttribute('contenteditable') !== 'true') return;

      el.setAttribute('contenteditable', 'false');

      var newContent = el.textContent.trim();
      if (newContent !== originalContent) {
        saveTextEdit(el, newContent);
      }

      currentEditElement = null;
      originalContent = '';
    }

    // Handle keydown (Enter to save, Escape to cancel)
    function handleEditableKeydown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        e.target.blur();
      } else if (e.key === 'Escape') {
        e.preventDefault();
        e.target.textContent = originalContent;
        e.target.blur();
      }
    }

    // ============================================
    // LIST ITEM EDITING (Pricing features, etc.)
    // ============================================

    var currentListItem = null;
    var originalListContent = '';

    // Initialize an editable list with delete buttons and add button
    function initEditableList(list) {
      // Add delete buttons to each item
      var items = list.querySelectorAll('[data-editable-list-item]');
      items.forEach(function(item) {
        if (!item.querySelector('.list-item-delete')) {
          var deleteBtn = document.createElement('button');
          deleteBtn.className = 'list-item-delete';
          deleteBtn.innerHTML = 'Ã—';
          deleteBtn.title = 'Delete this item';
          deleteBtn.onclick = function(e) {
            e.stopPropagation();
            deleteListItem(item);
          };
          item.appendChild(deleteBtn);
        }
      });

      // Add "add item" button if not present
      if (!list.querySelector('.list-add-item')) {
        var addBtn = document.createElement('button');
        addBtn.className = 'list-add-item';
        addBtn.innerHTML = '+ Add item';
        addBtn.onclick = function(e) {
          e.stopPropagation();
          addListItem(list);
        };
        list.appendChild(addBtn);
      }
    }

    // Handle click on list item
    function handleListItemClick(e) {
      e.preventDefault();
      e.stopPropagation();

      var el = e.target.closest('[data-editable-list-item]');
      if (!el || el.getAttribute('contenteditable') === 'true') return;

      // Store original content for cancel
      originalListContent = el.textContent.replace('Ã—', '').trim();
      currentListItem = el;

      // Make editable
      el.setAttribute('contenteditable', 'true');
      el.classList.add('editing');
      el.focus();

      // Select all text (excluding the delete button)
      var range = document.createRange();
      var textNode = el.firstChild;
      if (textNode && textNode.nodeType === Node.TEXT_NODE) {
        range.selectNodeContents(textNode);
        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }

    // Handle blur on list item
    function handleListItemBlur(e) {
      var el = e.target.closest('[data-editable-list-item]');
      if (!el || el.getAttribute('contenteditable') !== 'true') return;

      el.setAttribute('contenteditable', 'false');
      el.classList.remove('editing');

      // Get text content excluding delete button
      var newContent = '';
      el.childNodes.forEach(function(node) {
        if (node.nodeType === Node.TEXT_NODE) {
          newContent += node.textContent;
        }
      });
      newContent = newContent.trim();

      if (newContent !== originalListContent && newContent !== '') {
        saveListItemEdit(el, newContent);
      } else if (newContent === '' && originalListContent !== '') {
        // Restore if emptied
        el.childNodes.forEach(function(node) {
          if (node.nodeType === Node.TEXT_NODE) {
            node.textContent = originalListContent;
          }
        });
      }

      currentListItem = null;
      originalListContent = '';
    }

    // Handle keydown on list item
    function handleListItemKeydown(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        e.target.blur();
      } else if (e.key === 'Escape') {
        e.preventDefault();
        var el = e.target.closest('[data-editable-list-item]');
        if (el) {
          el.childNodes.forEach(function(node) {
            if (node.nodeType === Node.TEXT_NODE) {
              node.textContent = originalListContent;
            }
          });
          el.blur();
        }
      } else if (e.key === 'Backspace' || e.key === 'Delete') {
        // Allow normal deletion within text
        var el = e.target.closest('[data-editable-list-item]');
        if (el) {
          var textContent = '';
          el.childNodes.forEach(function(node) {
            if (node.nodeType === Node.TEXT_NODE) {
              textContent += node.textContent;
            }
          });
          // If empty after potential delete, allow but don't prevent
          // This fixes the "can't delete" issue
        }
      }
    }

    // Delete a list item
    function deleteListItem(item) {
      var list = item.closest('[data-editable-list]');
      var section = item.closest('[data-section-id]');
      if (!list || !section) return;

      var sectionId = section.getAttribute('data-section-id');
      var field = list.getAttribute('data-field');

      // Get all current items
      var items = list.querySelectorAll('[data-editable-list-item]');
      var newFeatures = [];
      items.forEach(function(li) {
        if (li !== item) {
          var text = '';
          li.childNodes.forEach(function(node) {
            if (node.nodeType === Node.TEXT_NODE) {
              text += node.textContent;
            }
          });
          newFeatures.push(text.trim());
        }
      });

      // Remove the item from DOM
      item.remove();

      // Save to backend
      saveListToBackend(sectionId, field, newFeatures);
    }

    // Add a new list item
    function addListItem(list) {
      var section = list.closest('[data-section-id]');
      if (!section) return;

      var sectionId = section.getAttribute('data-section-id');
      var field = list.getAttribute('data-field');

      // Create new list item
      var items = list.querySelectorAll('[data-editable-list-item]');
      var newIndex = items.length;

      var newItem = document.createElement('li');
      newItem.setAttribute('data-editable-list-item', '');
      newItem.setAttribute('data-list-index', newIndex);
      newItem.textContent = 'New feature';

      // Add delete button
      var deleteBtn = document.createElement('button');
      deleteBtn.className = 'list-item-delete';
      deleteBtn.innerHTML = 'Ã—';
      deleteBtn.title = 'Delete this item';
      deleteBtn.onclick = function(e) {
        e.stopPropagation();
        deleteListItem(newItem);
      };
      newItem.appendChild(deleteBtn);

      // Add event listeners
      newItem.addEventListener('click', handleListItemClick);
      newItem.addEventListener('blur', handleListItemBlur);
      newItem.addEventListener('keydown', handleListItemKeydown);

      // Insert before add button
      var addBtn = list.querySelector('.list-add-item');
      list.insertBefore(newItem, addBtn);

      // Get all features and save
      var newFeatures = [];
      list.querySelectorAll('[data-editable-list-item]').forEach(function(li) {
        var text = '';
        li.childNodes.forEach(function(node) {
          if (node.nodeType === Node.TEXT_NODE) {
            text += node.textContent;
          }
        });
        newFeatures.push(text.trim());
      });

      saveListToBackend(sectionId, field, newFeatures);

      // Start editing the new item
      newItem.click();
    }

    // Save list item edit
    function saveListItemEdit(el, newContent) {
      var list = el.closest('[data-editable-list]');
      var section = el.closest('[data-section-id]');
      if (!list || !section) return;

      var sectionId = section.getAttribute('data-section-id');
      var field = list.getAttribute('data-field');

      // Update the text node
      el.childNodes.forEach(function(node) {
        if (node.nodeType === Node.TEXT_NODE) {
          node.textContent = newContent;
        }
      });

      // Get all features
      var features = [];
      list.querySelectorAll('[data-editable-list-item]').forEach(function(li) {
        var text = '';
        li.childNodes.forEach(function(node) {
          if (node.nodeType === Node.TEXT_NODE) {
            text += node.textContent;
          }
        });
        features.push(text.trim());
      });

      saveListToBackend(sectionId, field, features);
    }

    // Save list changes to backend
    function saveListToBackend(sectionId, field, features) {
      // field is like "items.0.features" for pricing
      var parts = field.split('.');
      var currentSection = siteData.draftConfig.sections.find(function(s) { return s.id === sectionId; });
      if (!currentSection) return;

      // Navigate to the right place in the config
      if (parts[0] === 'items' && parts.length >= 3) {
        var itemIndex = parseInt(parts[1]);
        var propName = parts[2];
        if (currentSection.content.items && currentSection.content.items[itemIndex]) {
          currentSection.content.items[itemIndex][propName] = features;
        }
      }

      // Save to backend
      fetch('/api/sites/' + siteData.id, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ draftConfig: siteData.draftConfig })
      })
      .then(function(response) { return response.json(); })
      .then(function(data) {
        if (data.success) {
          console.log('[Builder] List saved successfully');
        }
      })
      .catch(function(error) {
        console.error('[Builder] Error saving list:', error);
      });
    }

    // Handle click on link/button element
    function handleLinkClick(e) {
      e.preventDefault();
      e.stopPropagation();

      currentLinkElement = e.target;
      var popup = document.getElementById('linkEditPopup');
      var textInput = document.getElementById('linkEditText');
      var urlInput = document.getElementById('linkEditUrl');

      // Pre-fill with current values
      textInput.value = currentLinkElement.textContent;
      urlInput.value = currentLinkElement.getAttribute('href') || '';

      // Position popup near the element
      var rect = currentLinkElement.getBoundingClientRect();
      popup.style.top = (rect.bottom + 10) + 'px';
      popup.style.left = Math.max(10, rect.left) + 'px';
      popup.classList.add('active');

      textInput.focus();
      textInput.select();
    }

    // Save link edit
    function saveLinkEdit() {
      if (!currentLinkElement) return;

      var textInput = document.getElementById('linkEditText');
      var urlInput = document.getElementById('linkEditUrl');
      var newText = textInput.value.trim();
      var newUrl = urlInput.value.trim();

      if (newText) {
        currentLinkElement.textContent = newText;
      }
      if (newUrl) {
        currentLinkElement.setAttribute('href', newUrl);
      }

      // Save to config
      var section = currentLinkElement.closest('[data-section-id]');
      var sectionId = section.getAttribute('data-section-id');
      var textField = currentLinkElement.getAttribute('data-field');
      var linkField = currentLinkElement.getAttribute('data-link-field');

      var updates = {};
      if (newText) updates[textField] = newText;
      if (newUrl) updates[linkField] = newUrl;

      saveToBackend(sectionId, updates);
      closeLinkEdit();
    }

    // Close link edit popup
    function closeLinkEdit() {
      document.getElementById('linkEditPopup').classList.remove('active');
      currentLinkElement = null;
    }

    // Initialize link edit popup buttons
    document.getElementById('linkEditSaveBtn').addEventListener('click', function(e) {
      e.stopPropagation();
      saveLinkEdit();
    });

    document.getElementById('linkEditCancelBtn').addEventListener('click', function(e) {
      e.stopPropagation();
      closeLinkEdit();
    });

    // Icon picker functionality
    var currentIconElement = null;
    var availableIcons = [
      'rocket', 'star', 'heart', 'check', 'shield', 'bolt',
      'globe', 'users', 'clock', 'chart-bar', 'lock', 'cloud',
      'code', 'phone', 'gear', 'headset', 'book', 'gift',
      'microchip', 'database', 'envelope', 'eye', 'file-lines', 'flag',
      'folder', 'house', 'image', 'key', 'layer-group', 'link',
      'map', 'bullhorn', 'moon', 'palette', 'pencil', 'user',
      'chart-pie', 'location-dot', 'play', 'circle-plus', 'power-off', 'puzzle-piece',
      'magnifying-glass', 'paper-plane', 'share', 'store', 'gauge', 'sun',
      'terminal', 'trophy', 'truck', 'wifi', 'wrench', 'magnifying-glass-plus'
    ];

    // Initialize icon picker grid
    function initIconPicker() {
      var grid = document.getElementById('iconPickerGrid');
      if (!grid) return;

      grid.innerHTML = '';
      availableIcons.forEach(function(icon) {
        var item = document.createElement('div');
        item.className = 'icon-picker-item';
        item.setAttribute('data-icon', icon);
        item.innerHTML = '<i class="fa-solid fa-' + icon + '"></i>';
        item.onclick = function() { selectIcon(icon); };
        grid.appendChild(item);
      });
    }

    // Handle click on editable icon
    function handleIconClick(e) {
      e.preventDefault();
      e.stopPropagation();

      currentIconElement = e.currentTarget;
      var popup = document.getElementById('iconPickerPopup');
      var currentIcon = currentIconElement.getAttribute('data-current-icon') || 'star';

      // Update selected state in grid
      var items = document.querySelectorAll('.icon-picker-item');
      items.forEach(function(item) {
        item.classList.remove('selected');
        if (item.getAttribute('data-icon') === currentIcon) {
          item.classList.add('selected');
        }
      });

      // Position popup near the element
      var rect = currentIconElement.getBoundingClientRect();
      popup.style.top = (rect.bottom + 10) + 'px';
      popup.style.left = Math.max(10, rect.left - 100) + 'px';
      popup.classList.add('active');
    }

    // Select icon from picker
    function selectIcon(iconName) {
      if (!currentIconElement) return;

      // Update the icon element
      var iconEl = currentIconElement.querySelector('i');
      if (iconEl) {
        iconEl.className = 'fa-solid fa-' + iconName;
      }
      currentIconElement.setAttribute('data-current-icon', iconName);

      // Save to config
      var section = currentIconElement.closest('[data-section-id]');
      var sectionId = section.getAttribute('data-section-id');
      var field = currentIconElement.getAttribute('data-field');

      // Handle nested field (items.0.icon)
      var parts = field.split('.');
      if (parts[0] === 'items' && parts.length >= 3) {
        var itemIndex = parseInt(parts[1]);
        var currentSection = siteData.draftConfig.sections.find(s => s.id === sectionId);
        if (currentSection && currentSection.content.items) {
          var items = JSON.parse(JSON.stringify(currentSection.content.items));
          items[itemIndex].icon = iconName;
          saveToBackend(sectionId, { items: items });
        }
      }

      closeIconPicker();
    }

    // Close icon picker popup
    function closeIconPicker() {
      document.getElementById('iconPickerPopup').classList.remove('active');
      currentIconElement = null;
    }

    // Close popups when clicking outside
    document.addEventListener('click', function(e) {
      var linkPopup = document.getElementById('linkEditPopup');
      var iconPopup = document.getElementById('iconPickerPopup');

      if (linkPopup.classList.contains('active') && !linkPopup.contains(e.target) && !e.target.hasAttribute('data-editable-link')) {
        closeLinkEdit();
      }
      if (iconPopup.classList.contains('active') && !iconPopup.contains(e.target) && !e.target.closest('[data-editable-icon]')) {
        closeIconPicker();
      }
    });

    // Drag and drop section reordering
    var draggedSection = null;
    var draggedSectionId = null;

    function initDragAndDrop() {
      var sections = previewFrame.querySelectorAll('[data-section-id]');
      sections.forEach(function(section) {
        // Add drag handle if not present
        if (!section.querySelector('.section-drag-handle')) {
          var handle = document.createElement('div');
          handle.className = 'section-drag-handle';
          handle.innerHTML = '<i class="fa-solid fa-grip-vertical"></i>';
          handle.setAttribute('draggable', 'true');
          handle.setAttribute('title', 'Drag to reorder');
          section.appendChild(handle);

          // Add drop indicators
          var topIndicator = document.createElement('div');
          topIndicator.className = 'drop-indicator-top';
          section.appendChild(topIndicator);

          var bottomIndicator = document.createElement('div');
          bottomIndicator.className = 'drop-indicator-bottom';
          section.appendChild(bottomIndicator);
        }

        // Make section draggable via handle
        var handle = section.querySelector('.section-drag-handle');
        handle.addEventListener('dragstart', handleDragStart);
        handle.addEventListener('dragend', handleDragEnd);

        // Section as drop target
        section.addEventListener('dragover', handleDragOver);
        section.addEventListener('dragleave', handleDragLeave);
        section.addEventListener('drop', handleDrop);
      });
    }

    function handleDragStart(e) {
      var section = e.target.closest('[data-section-id]');
      draggedSection = section;
      draggedSectionId = section.getAttribute('data-section-id');

      // Use setTimeout to allow the drag image to be captured first
      setTimeout(function() {
        section.classList.add('dragging');
      }, 0);

      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', draggedSectionId);
    }

    function handleDragEnd(e) {
      if (draggedSection) {
        draggedSection.classList.remove('dragging');
      }

      // Remove all drag-over classes
      var sections = previewFrame.querySelectorAll('[data-section-id]');
      sections.forEach(function(s) {
        s.classList.remove('drag-over', 'drag-over-top', 'drag-over-bottom');
      });

      draggedSection = null;
      draggedSectionId = null;
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';

      var section = e.target.closest('[data-section-id]');
      if (!section || section === draggedSection) return;

      // Determine if we're in the top or bottom half
      var rect = section.getBoundingClientRect();
      var midpoint = rect.top + rect.height / 2;

      // Remove previous indicators
      var sections = previewFrame.querySelectorAll('[data-section-id]');
      sections.forEach(function(s) {
        if (s !== section) {
          s.classList.remove('drag-over-top', 'drag-over-bottom');
        }
      });

      if (e.clientY < midpoint) {
        section.classList.remove('drag-over-bottom');
        section.classList.add('drag-over-top');
      } else {
        section.classList.remove('drag-over-top');
        section.classList.add('drag-over-bottom');
      }
    }

    function handleDragLeave(e) {
      var section = e.target.closest('[data-section-id]');
      if (!section) return;

      // Only remove if we're actually leaving the section
      var rect = section.getBoundingClientRect();
      if (e.clientX < rect.left || e.clientX > rect.right ||
          e.clientY < rect.top || e.clientY > rect.bottom) {
        section.classList.remove('drag-over-top', 'drag-over-bottom');
      }
    }

    function handleDrop(e) {
      e.preventDefault();

      var targetSection = e.target.closest('[data-section-id]');
      if (!targetSection || !draggedSectionId) return;

      var targetSectionId = targetSection.getAttribute('data-section-id');
      if (targetSectionId === draggedSectionId) return;

      // Determine drop position
      var rect = targetSection.getBoundingClientRect();
      var dropBefore = e.clientY < rect.top + rect.height / 2;

      // Reorder sections in config
      reorderSections(draggedSectionId, targetSectionId, dropBefore);

      // Clean up
      targetSection.classList.remove('drag-over-top', 'drag-over-bottom');
    }

    function reorderSections(draggedId, targetId, dropBefore) {
      if (!siteData || !siteData.draftConfig || !siteData.draftConfig.sections) return;

      var sections = siteData.draftConfig.sections;

      // Find indices
      var draggedIndex = sections.findIndex(function(s) { return s.id === draggedId; });
      var targetIndex = sections.findIndex(function(s) { return s.id === targetId; });

      if (draggedIndex === -1 || targetIndex === -1) return;

      // Remove dragged section
      var draggedItem = sections.splice(draggedIndex, 1)[0];

      // Recalculate target index after removal
      if (draggedIndex < targetIndex) {
        targetIndex--;
      }

      // Insert at new position
      var insertIndex = dropBefore ? targetIndex : targetIndex + 1;
      sections.splice(insertIndex, 0, draggedItem);

      // Update order values
      sections.forEach(function(s, i) {
        s.order = i;
      });

      // Save to backend
      saveSectionOrder();

      // Refresh preview
      refreshPreview(siteData.draftConfig);
    }

    function saveSectionOrder() {
      if (!siteData || !siteData.draftConfig) return;

      console.log('[Builder] Saving section order...');
      showSaveIndicator('saving');

      fetch('/api/sites/' + siteId, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ draftConfig: siteData.draftConfig })
      })
      .then(function(response) {
        if (!response.ok) throw new Error('Failed to save');
        return response.json();
      })
      .then(function(data) {
        console.log('[Builder] Section order saved');
        showSaveIndicator('success');
      })
      .catch(function(error) {
        console.error('[Builder] Error saving order:', error);
        showSaveIndicator('error', 'Failed to save order');
      });
    }

    // Save text edit to config
    function saveTextEdit(el, newContent) {
      var section = el.closest('[data-section-id]');
      if (!section) return;

      var sectionId = section.getAttribute('data-section-id');
      var field = el.getAttribute('data-field');

      var updates = {};

      // Handle nested fields like items.0.title
      if (field.includes('.')) {
        var parts = field.split('.');
        if (parts[0] === 'items') {
          var itemIndex = parseInt(parts[1]);
          var itemField = parts[2];
          // We need to get the full items array and update it
          var currentSection = siteData.draftConfig.sections.find(s => s.id === sectionId);
          if (currentSection && currentSection.content.items) {
            var items = JSON.parse(JSON.stringify(currentSection.content.items));
            items[itemIndex][itemField] = newContent;
            updates.items = items;
          }
        }
      } else {
        updates[field] = newContent;
      }

      saveToBackend(sectionId, updates);
    }

    // Save changes to backend (immediate - no debounce for reliability)
    var isSaving = false;
    var pendingSave = null;

    function saveToBackend(sectionId, contentUpdates) {
      // Update local config immediately
      var section = siteData.draftConfig.sections.find(s => s.id === sectionId);
      if (section) {
        Object.assign(section.content, contentUpdates);
      }

      // If already saving, queue this save
      if (isSaving) {
        pendingSave = { sectionId: sectionId, updates: contentUpdates };
        return;
      }

      doSave();
    }

    var currentSaveIndicator = null;

    function doSave() {
      if (!siteData || !siteData.draftConfig) return;

      isSaving = true;
      console.log('[Builder] Saving changes to backend...');

      // Show saving indicator
      showSaveIndicator('saving');

      fetch('/api/sites/' + siteId, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ draftConfig: siteData.draftConfig })
      })
      .then(function(res) { return res.json(); })
      .then(function(data) {
        isSaving = false;
        if (data.success) {
          console.log('[Builder] Save successful');
          showSaveIndicator('success');

          // Process any pending save
          if (pendingSave) {
            var pending = pendingSave;
            pendingSave = null;
            saveToBackend(pending.sectionId, pending.updates);
          }
        } else {
          console.error('[Builder] Save failed:', data.error);
          showSaveIndicator('error', data.error || 'Save failed');
        }
      })
      .catch(function(err) {
        isSaving = false;
        console.error('[Builder] Save error:', err);
        showSaveIndicator('error', 'Connection error');
      });
    }

    // Show save indicator with different states
    function showSaveIndicator(state, message) {
      // Remove existing indicator
      if (currentSaveIndicator) {
        currentSaveIndicator.remove();
        currentSaveIndicator = null;
      }

      var indicator = document.createElement('div');
      indicator.className = 'save-indicator';

      if (state === 'saving') {
        indicator.classList.add('saving');
        indicator.innerHTML = '<div class="save-spinner"></div> Saving...';
        // Don't auto-remove while saving
        indicator.style.animation = 'slideIn 0.3s ease';
      } else if (state === 'success') {
        indicator.innerHTML = '<i class="fa-solid fa-circle-check"></i> Saved';
        setTimeout(function() {
          if (indicator.parentNode) indicator.remove();
          currentSaveIndicator = null;
        }, 2000);
      } else if (state === 'error') {
        indicator.classList.add('error');
        indicator.innerHTML = '<i class="fa-solid fa-circle-xmark"></i> ' + (message || 'Error');
        setTimeout(function() {
          if (indicator.parentNode) indicator.remove();
          currentSaveIndicator = null;
        }, 3000);
      }

      document.body.appendChild(indicator);
      currentSaveIndicator = indicator;
    }

    // ============================================
    // END WYSIWYG
    // ============================================

    // Escape HTML
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Publish site
    async function publishSite() {
      if (!siteId || isProcessing) return;

      if (!confirm('Ready to publish your site? It will be live at ' + siteData.slug + '.devopser.io')) {
        return;
      }

      publishBtn.disabled = true;
      publishBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Publishing...';

      try {
        const response = await fetch(`/api/sites/${siteId}/publish`, {
          method: 'POST',
          credentials: 'same-origin'
        });

        const data = await response.json();

        if (data.success) {
          addMessage('system', 'Deployment started! Your site will be live shortly at ' + siteData.slug + '.devopser.io');
          // Reload after a delay to show updated status
          setTimeout(() => location.reload(), 3000);
        } else {
          addMessage('system', 'Error: ' + (data.error || 'Failed to publish'));
          publishBtn.disabled = false;
          publishBtn.innerHTML = '<i class="fa-solid fa-rocket me-1"></i> Publish';
        }
      } catch (error) {
        console.error('Publish error:', error);
        addMessage('system', 'Error: Failed to publish. Please try again.');
        publishBtn.disabled = false;
        publishBtn.innerHTML = '<i class="fa-solid fa-rocket me-1"></i> Publish';
      }
    }

    // Event listeners
    sendBtn.addEventListener('click', sendMessage);

    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    if (publishBtn) {
      publishBtn.addEventListener('click', publishSite);
    }

    if (refreshPreviewBtn) {
      refreshPreviewBtn.addEventListener('click', () => {
        if (siteData && siteData.draftConfig) {
          refreshPreview(siteData.draftConfig);
        }
      });
    }

    // Delete site (in status dropdown)
    const deleteSiteBtn = document.getElementById('delete-site-btn');
    if (deleteSiteBtn) {
      deleteSiteBtn.addEventListener('click', async () => {
        const siteName = siteData ? siteData.name : 'this site';
        const confirmMsg = `Are you sure you want to delete "${siteName}"?\n\nThis action cannot be undone. All site data will be permanently deleted.`;

        if (!confirm(confirmMsg)) {
          return;
        }

        // Double confirm for safety
        const confirmAgain = prompt(`Type "DELETE" to confirm deletion of "${siteName}":`);
        if (confirmAgain !== 'DELETE') {
          alert('Deletion cancelled. You must type DELETE to confirm.');
          return;
        }

        deleteSiteBtn.disabled = true;
        deleteSiteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Deleting...';

        try {
          const response = await fetch(`/api/sites/${siteId}`, {
            method: 'DELETE',
            credentials: 'same-origin'
          });

          const data = await response.json();

          if (data.success) {
            alert('Site deleted successfully.');
            window.location.href = '/sites';
          } else {
            alert('Error: ' + (data.error || 'Failed to delete site'));
            deleteSiteBtn.disabled = false;
            deleteSiteBtn.innerHTML = '<i class="fa-solid fa-trash me-1"></i> Delete Site';
          }
        } catch (error) {
          console.error('Delete error:', error);
          alert('Error: Failed to delete site. Please try again.');
          deleteSiteBtn.disabled = false;
          deleteSiteBtn.innerHTML = '<i class="fa-solid fa-trash me-1"></i> Delete Site';
        }
      });
    }

    // ============================================
    // IMAGE PICKER FUNCTIONALITY
    // ============================================

    var imagePickerModal = document.getElementById('imagePickerModal');
    var closeImagePickerBtn = document.getElementById('closeImagePicker');
    var imageUploadZone = document.getElementById('imageUploadZone');
    var imageFileInput = document.getElementById('imageFileInput');
    var siteImagesGrid = document.getElementById('siteImagesGrid');
    var noImagesMessage = document.getElementById('noImagesMessage');
    var uploadProgress = document.getElementById('uploadProgress');
    var currentImageElement = null;
    var currentImageField = null;
    var siteImages = [];

    // Open image picker
    function openImagePicker(element, field) {
      currentImageElement = element;
      currentImageField = field;
      imagePickerModal.classList.add('active');
      loadSiteImages();
    }

    // Close image picker
    function closeImagePicker() {
      imagePickerModal.classList.remove('active');
      currentImageElement = null;
      currentImageField = null;
    }

    // Load site images
    async function loadSiteImages() {
      if (!siteId) return;

      try {
        const response = await fetch('/api/sites/' + siteId + '/images', {
          credentials: 'same-origin'
        });
        const data = await response.json();

        if (data.success) {
          siteImages = data.images || [];
          renderSiteImages();
        }
      } catch (error) {
        console.error('Error loading images:', error);
      }
    }

    // Render site images grid
    function renderSiteImages() {
      siteImagesGrid.innerHTML = '';

      if (siteImages.length === 0) {
        noImagesMessage.style.display = 'block';
        return;
      }

      noImagesMessage.style.display = 'none';

      siteImages.forEach(function(image) {
        var item = document.createElement('div');
        item.className = 'site-image-item';
        item.innerHTML = '<img src="' + escapeHtml(image.url) + '" alt="Site image">';
        item.addEventListener('click', function() {
          selectImage(image.url);
        });
        siteImagesGrid.appendChild(item);
      });
    }

    // Select an image
    function selectImage(url) {
      if (!currentImageElement || !currentImageField) return;

      // Update the preview
      var img = currentImageElement.querySelector('img');
      var icon = currentImageElement.querySelector('i');

      if (img) {
        img.src = url;
      } else if (icon) {
        // Replace icon with image
        currentImageElement.innerHTML = '<img src="' + escapeHtml(url) + '" alt="Image">';
      }

      // Update the config
      updateConfigField(currentImageField, url);

      closeImagePicker();
    }

    // Upload image
    async function uploadImage(file) {
      if (!siteId) return;

      var formData = new FormData();
      formData.append('image', file);

      uploadProgress.style.display = 'block';
      var progressBar = uploadProgress.querySelector('.progress-bar');
      progressBar.style.width = '30%';

      try {
        const response = await fetch('/api/sites/' + siteId + '/images/upload', {
          method: 'POST',
          credentials: 'same-origin',
          body: formData
        });

        progressBar.style.width = '100%';

        const data = await response.json();

        if (data.success) {
          siteImages.unshift(data.image);
          renderSiteImages();
          // Auto-select the uploaded image
          selectImage(data.image.url);
        } else {
          alert('Upload failed: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Upload error:', error);
        alert('Upload failed: ' + error.message);
      } finally {
        setTimeout(function() {
          uploadProgress.style.display = 'none';
          progressBar.style.width = '0%';
        }, 500);
      }
    }

    // Update config field for images
    function updateConfigField(fieldPath, value) {
      if (!siteData || !siteData.draftConfig) return;

      var sectionEl = currentImageElement.closest('[data-section-id]');
      if (!sectionEl) return;

      var sectionId = sectionEl.getAttribute('data-section-id');
      var section = siteData.draftConfig.sections.find(function(s) { return s.id === sectionId; });
      if (!section) return;

      // Parse the field path and set the value
      var parts = fieldPath.split('.');
      var obj = section.content;

      for (var i = 0; i < parts.length - 1; i++) {
        var part = parts[i];
        var indexMatch = part.match(/^(\w+)\.(\d+)$/);
        if (indexMatch) {
          obj = obj[indexMatch[1]][parseInt(indexMatch[2])];
        } else if (!isNaN(parseInt(part))) {
          obj = obj[parseInt(part)];
        } else {
          if (!obj[part]) obj[part] = {};
          obj = obj[part];
        }
      }

      var lastPart = parts[parts.length - 1];
      obj[lastPart] = value;

      // Save to server
      saveConfig();
    }

    // Event listeners for image picker
    if (closeImagePickerBtn) {
      closeImagePickerBtn.addEventListener('click', closeImagePicker);
    }

    if (imagePickerModal) {
      imagePickerModal.addEventListener('click', function(e) {
        if (e.target === imagePickerModal) {
          closeImagePicker();
        }
      });
    }

    if (imageUploadZone) {
      imageUploadZone.addEventListener('click', function() {
        imageFileInput.click();
      });

      imageUploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        imageUploadZone.classList.add('dragover');
      });

      imageUploadZone.addEventListener('dragleave', function() {
        imageUploadZone.classList.remove('dragover');
      });

      imageUploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        imageUploadZone.classList.remove('dragover');
        var files = e.dataTransfer.files;
        if (files.length > 0) {
          uploadImage(files[0]);
        }
      });
    }

    if (imageFileInput) {
      imageFileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
          uploadImage(this.files[0]);
        }
      });
    }

    // Handle clicks on editable image elements
    function handleImageClick(e) {
      e.preventDefault();
      e.stopPropagation();
      var el = e.target.closest('[data-editable-image]');
      if (el) {
        var field = el.getAttribute('data-field');
        openImagePicker(el, field);
      }
    }

    // Initialize editable image elements
    function initEditableImages() {
      var imageElements = previewFrame.querySelectorAll('[data-editable-image]');
      imageElements.forEach(function(el) {
        el.addEventListener('click', handleImageClick);
        el.style.cursor = 'pointer';
      });
    }

    // Call initEditableImages after preview is rendered
    var originalInitEditableElements = initEditableElements;
    initEditableElements = function() {
      originalInitEditableElements();
      initEditableImages();
    };

    // Apply hero background from data attributes on page load (CSP-compliant)
    function applyHeroBackground() {
      var heroEl = document.querySelector('.section-hero');
      if (heroEl) {
        var bgStart = heroEl.getAttribute('data-bg-start');
        var bgEnd = heroEl.getAttribute('data-bg-end');
        if (bgStart && bgEnd) {
          heroEl.style.background = 'linear-gradient(135deg, ' + bgStart + ', ' + bgEnd + ')';
        }
      }
    }
    applyHeroBackground();
    initEditableElements();

    // Focus chat input on load
    chatInput.focus();
  </script>
</body>
</html>
