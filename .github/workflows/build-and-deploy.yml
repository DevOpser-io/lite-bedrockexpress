name: Build and Deploy

on:
  repository_dispatch:
    types: [trigger-build]
  push:
    branches: [ "main", "staging" ]
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  build:
    # Only run if not a Dependabot PR
    if: ${{ github.actor != 'dependabot[bot]' }}
    runs-on: ubuntu-22.04
    permissions:
      id-token: write
      contents: read
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # Add Node.js setup with specific version
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.9.0'

    # Cache npm dependencies
    - name: Cache npm dependencies
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-20.9.0-${{ hashFiles('package-lock.json', '**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-20.9.0-

    # Install and build frontend assets
    - name: Install npm dependencies
      run: |
        npm ci

    - name: Install TypeScript and esbuild for mobile build
      run: |
        npm install -g typescript esbuild

    - name: Build frontend assets
      run: |
        npm run frontend:build

    # Generate app association files from templates with GitHub secrets
    - name: Generate App Association Files
      env:
        ANDROID_DEBUG_SHA256: ${{ secrets.ANDROID_DEBUG_SHA256 }}
        ANDROID_RELEASE_SHA256: ${{ secrets.ANDROID_RELEASE_SHA256 }}
        ANDROID_PLAY_SIGNING_SHA256: ${{ secrets.ANDROID_PLAY_SIGNING_SHA256 }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
      run: |
        echo "Generating app association files..."

        # Android assetlinks.json
        echo "üì± Generating Android assetlinks.json..."
        DEBUG_SHA="${ANDROID_DEBUG_SHA256:-FA:C6:17:45:DC:09:03:78:6F:B9:ED:E6:2A:96:2B:39:9F:73:48:F0:BB:6F:89:9B:83:32:66:75:91:03:3B:9C}"
        RELEASE_SHA="${ANDROID_RELEASE_SHA256:-${ANDROID_PLAY_SIGNING_SHA256}}"

        if [ -z "$RELEASE_SHA" ]; then
          echo "‚ö†Ô∏è  No ANDROID_RELEASE_SHA256 or ANDROID_PLAY_SIGNING_SHA256 secret found, using debug SHA"
          RELEASE_SHA="$DEBUG_SHA"
        fi

        if [ -f "backend/public/.well-known/assetlinks.json.template" ]; then
          sed -e "s/__DEBUG_SHA256__/$DEBUG_SHA/g" \
              -e "s/__RELEASE_SHA256__/$RELEASE_SHA/g" \
              backend/public/.well-known/assetlinks.json.template > backend/public/.well-known/assetlinks.json
          echo "‚úÖ Generated assetlinks.json"
          cat backend/public/.well-known/assetlinks.json
        else
          echo "‚ö†Ô∏è  assetlinks.json.template not found, keeping existing file"
        fi

        # iOS apple-app-site-association
        echo "üçé Generating iOS apple-app-site-association..."
        TEAM_ID="${APPLE_TEAM_ID:-YOUR_TEAM_ID}"
        BUNDLE_ID="${IOS_BUNDLE_ID:-com.example.app}"

        if [ -z "$APPLE_TEAM_ID" ]; then
          echo "‚ö†Ô∏è  No APPLE_TEAM_ID secret found, using placeholder"
        fi

        if [ -f "backend/public/.well-known/apple-app-site-association.template" ]; then
          sed -e "s/__IOS_TEAM_ID__/$TEAM_ID/g" \
              -e "s/__IOS_BUNDLE_ID__/$BUNDLE_ID/g" \
              backend/public/.well-known/apple-app-site-association.template > backend/public/.well-known/apple-app-site-association
          echo "‚úÖ Generated apple-app-site-association"
          cat backend/public/.well-known/apple-app-site-association
        else
          echo "‚ö†Ô∏è  apple-app-site-association.template not found, keeping existing file"
        fi

    # Mobile Build Steps
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Prepare Mobile Environment
      run: |
        # Use the build-mobile.sh script with appropriate environment
        chmod +x build-mobile.sh

        # Set environment based on branch
        if [[ "${{ github.ref_name }}" == "main" ]]; then
          echo "Building for production environment"
          export MOBILE_ENV=production
          ./build-mobile.sh
        elif [[ "${{ github.ref_name }}" == "staging" ]]; then
          echo "Building for staging environment"
          export MOBILE_ENV=staging
          ./build-mobile.sh
        else
          echo "Building for development environment"
          export MOBILE_ENV=local
          ./build-mobile.sh
        fi

        # Copy built assets to Android
        if [ -d "android/app/src/main/assets" ]; then
          rm -rf android/app/src/main/assets/public
          mkdir -p android/app/src/main/assets/public
          cp -r frontend/public/static/dist/* android/app/src/main/assets/public/
          echo "‚úÖ Mobile assets copied to Android"
          ls -la android/app/src/main/assets/public/
        fi

    - name: Initialize and Sync Capacitor
      env:
        ANDROID_PACKAGE_NAME: ${{ secrets.ANDROID_PACKAGE_NAME }}
      run: |
        # Use package name from secrets or default
        PACKAGE_NAME="${ANDROID_PACKAGE_NAME:-com.example.app}"
        APP_NAME="My App"

        # Initialize Capacitor if needed
        if [ ! -f capacitor.config.json ]; then
          npx cap init "$APP_NAME" "$PACKAGE_NAME" --web-dir="frontend/public/static/dist"
        fi

        # Update appId in capacitor.config.json from environment variable
        if [ -n "$ANDROID_PACKAGE_NAME" ] && [ -f capacitor.config.json ]; then
          echo "üìù Updating capacitor.config.json with package name from ANDROID_PACKAGE_NAME secret..."
          node -e "
            const fs = require('fs');
            const config = JSON.parse(fs.readFileSync('capacitor.config.json', 'utf8'));
            config.appId = process.env.ANDROID_PACKAGE_NAME;
            fs.writeFileSync('capacitor.config.json', JSON.stringify(config, null, 2));
            console.log('‚úÖ Updated appId to: ' + process.env.ANDROID_PACKAGE_NAME);
          "
        fi

        # Add platforms if not already added
        if [ ! -d android ]; then
          npx cap add android
        fi

        # Sync the app
        npx cap sync android

    - name: Decode Android Keystore
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
      env:
        ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      run: |
        if [ -n "$ANDROID_KEYSTORE_BASE64" ]; then
          echo "Decoding Android keystore..."
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/upload-keystore.jks
          echo "‚úÖ Keystore decoded and ready at android/app/upload-keystore.jks"
        else
          echo "‚ö†Ô∏è Skipping keystore setup - ANDROID_KEYSTORE_BASE64 not set"
        fi

    - name: Configure Android Build with Signing
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
      env:
        ANDROID_PACKAGE_NAME: ${{ secrets.ANDROID_PACKAGE_NAME }}
      run: |
        PACKAGE_NAME="${ANDROID_PACKAGE_NAME:-com.example.app}"
        echo "üìù Configuring Android build for $PACKAGE_NAME..."
        sed "s/__PACKAGE_NAME__/$PACKAGE_NAME/g" android-build.gradle.template > android/app/build.gradle
        cp android-variables.gradle.template android/variables.gradle
        cp android-root-build.gradle.template android/build.gradle
        cp android-gradle-wrapper.properties.template android/gradle/wrapper/gradle-wrapper.properties
        echo "‚úÖ Configured Android build with Gradle 8.11.1"

    - name: Build Android APK and AAB
      env:
        ANDROID_KEYSTORE_FILE: ${{ github.workspace }}/android/app/upload-keystore.jks
        ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        VERSION_CODE: ${{ github.run_number }}
        # Enable WebView debugging for staging builds (for chrome://inspect)
        ENABLE_WEBVIEW_DEBUG: ${{ github.ref == 'refs/heads/staging' && 'true' || 'false' }}
      run: |
        cd android
        chmod +x gradlew

        # Mask sensitive values in logs
        if [ -n "$ANDROID_KEYSTORE_PASSWORD" ]; then
          echo "::add-mask::$ANDROID_KEYSTORE_PASSWORD"
        fi
        if [ -n "$ANDROID_KEY_PASSWORD" ]; then
          echo "::add-mask::$ANDROID_KEY_PASSWORD"
        fi
        if [ -n "$ANDROID_KEY_ALIAS" ]; then
          echo "::add-mask::$ANDROID_KEY_ALIAS"
        fi

        # Build release APK/AAB if on main or staging branch and keystore is available
        if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == "refs/heads/staging" ]] && [[ -f "app/upload-keystore.jks" ]]; then
          echo "‚úÖ Building RELEASE APK and AAB with production signing..."
          echo "‚ÑπÔ∏è  Using keystore: upload-keystore.jks"
          echo "‚ÑπÔ∏è  Key alias: ***"
          echo "‚ÑπÔ∏è  Branch: ${{ github.ref_name }}"
          echo "‚ÑπÔ∏è  Version code: $VERSION_CODE"
          if [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "‚ÑπÔ∏è  WebView debugging: ENABLED (use chrome://inspect)"
          else
            echo "‚ÑπÔ∏è  WebView debugging: DISABLED (production)"
          fi
          ./gradlew assembleRelease bundleRelease --no-daemon
          APK_TYPE="release"
          APK_DIR="app/build/outputs/apk/release"
          AAB_DIR="app/build/outputs/bundle/release"
        else
          if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "‚ö†Ô∏è  Production keystore not found - building DEBUG APK instead"
            echo "‚ö†Ô∏è  To build signed releases, add ANDROID_KEYSTORE_BASE64 secret to GitHub"
          else
            echo "‚ÑπÔ∏è  Building DEBUG APK for ${{ github.ref_name }} branch..."
          fi
          ./gradlew assembleDebug --no-daemon
          APK_TYPE="debug"
          APK_DIR="app/build/outputs/apk/debug"
          AAB_DIR=""
        fi

        # Find and display APK location
        APK_LOCATION=$(find . -name "*.apk" -type f -path "*/$APK_TYPE/*" | head -1)
        if [ -n "$APK_LOCATION" ]; then
          echo "‚úÖ Found $APK_TYPE APK at: $APK_LOCATION"
          ls -la $APK_DIR || echo "$APK_TYPE directory not found"
        else
          echo "‚ùå No APK found!"
          exit 1
        fi

        # Check for AAB if release build
        if [[ -n "$AAB_DIR" ]]; then
          AAB_LOCATION=$(find . -name "*.aab" -type f -path "*/$APK_TYPE/*" | head -1)
          if [ -n "$AAB_LOCATION" ]; then
            echo "‚úÖ Found AAB at: $AAB_LOCATION"
            ls -la $AAB_DIR || echo "AAB directory not found"
          fi
        fi

        # Verify signing for release builds
        if [[ "$APK_TYPE" == "release" ]]; then
          echo ""
          echo "üîê Verifying APK/AAB signatures..."

          # Verify APK signature
          if [ -n "$APK_LOCATION" ]; then
            echo "Verifying APK signature..."
            if jarsigner -verify -verbose "$APK_LOCATION" | grep -q "jar verified"; then
              echo "‚úÖ APK is properly signed"
              # Extract and display certificate info (masked)
              CERT_INFO=$(jarsigner -verify -verbose -certs "$APK_LOCATION" 2>&1 | grep "SHA-256" | head -1)
              if [ -n "$CERT_INFO" ]; then
                echo "üìù Certificate SHA-256 fingerprint found in APK"
              fi
            else
              echo "‚ùå WARNING: APK signature verification failed!"
              echo "The APK may not be properly signed. Check your keystore configuration."
            fi
          fi

          # Verify AAB if it exists
          if [ -n "$AAB_LOCATION" ]; then
            echo "Verifying AAB signature..."
            if jarsigner -verify "$AAB_LOCATION" | grep -q "jar verified"; then
              echo "‚úÖ AAB is properly signed and ready for Play Store upload"
            else
              echo "‚ùå WARNING: AAB signature verification failed!"
              echo "The AAB may not be properly signed. Check your keystore configuration."
            fi
          fi
          echo ""
        fi

        # Set environment variables for artifact upload
        echo "APK_PATH=$(pwd)/$APK_LOCATION" >> $GITHUB_ENV
        echo "APK_TYPE=$APK_TYPE" >> $GITHUB_ENV
        echo "AAB_DIR=$AAB_DIR" >> $GITHUB_ENV

    # Sanitize branch name for artifact naming (remove invalid characters)
    - name: Sanitize branch name for artifacts
      run: |
        BRANCH_NAME="${{ github.ref_name }}"
        SANITIZED_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[\/:\\<>|*?"]/-/g')
        echo "SANITIZED_BRANCH_NAME=$SANITIZED_BRANCH" >> $GITHUB_ENV
        echo "Original branch: $BRANCH_NAME"
        echo "Sanitized branch: $SANITIZED_BRANCH"

    # Upload Mobile Binaries as Artifacts
    - name: Upload Android APK
      uses: actions/upload-artifact@v4
      with:
        name: Mobile-Android-APK-${{ env.APK_TYPE }}-${{ env.SANITIZED_BRANCH_NAME }}-${{ github.run_number }}
        path: android/app/build/outputs/apk/${{ env.APK_TYPE }}/*.apk
        retention-days: 30
        if-no-files-found: error

    - name: Upload Android App Bundle (AAB)
      if: env.AAB_DIR != ''
      uses: actions/upload-artifact@v4
      with:
        name: Mobile-Android-AAB-${{ env.APK_TYPE }}-${{ env.SANITIZED_BRANCH_NAME }}-${{ github.run_number }}
        path: android/app/build/outputs/bundle/${{ env.APK_TYPE }}/*.aab
        retention-days: 30
        if-no-files-found: warn

    - name: Check Google Play Upload Configuration
      if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging') && env.AAB_DIR != ''
      id: check-google-play
      env:
        GOOGLE_PLAY_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
      run: |
        if [ -n "$GOOGLE_PLAY_JSON" ]; then
          echo "configured=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Google Play service account configured - will attempt upload"
          echo "‚ÑπÔ∏è  Branch: ${{ github.ref_name }} - uploading to internal track"
        else
          echo "configured=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è  Google Play automatic upload not configured"
          echo ""
          echo "To enable automatic uploads to Google Play Console:"
          echo "1. Create a Google Cloud Service Account"
          echo "2. Enable Google Play Developer API"
          echo "3. Grant access in Play Console"
          echo "4. Add service account JSON as GitHub Secret: GOOGLE_PLAY_SERVICE_ACCOUNT_JSON"
          echo ""
          echo "üì• Download the AAB from artifacts below and upload manually to Play Console"
        fi

    - name: Upload to Google Play Console (Internal Track)
      if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging') && env.AAB_DIR != '' && steps.check-google-play.outputs.configured == 'true'
      continue-on-error: true
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        packageName: ${{ secrets.ANDROID_PACKAGE_NAME }}
        releaseFiles: android/app/build/outputs/bundle/${{ env.APK_TYPE }}/app-${{ env.APK_TYPE }}.aab
        track: internal
        status: draft
        inAppUpdatePriority: 2
        releaseName: ${{ github.ref_name == 'staging' && format('[STAGING] Build {0}', github.run_number) || format('Build {0}', github.run_number) }}

    - name: Cleanup Android Keystore and Secrets
      if: always()
      run: |
        echo "üßπ Cleaning up sensitive files..."
        # Remove keystore file
        rm -f android/app/upload-keystore.jks
        rm -f android/app/*.jks
        rm -f android/app/*.keystore
        # Clear Gradle cache that might contain signing info
        rm -rf ~/.gradle/caches/
        rm -rf android/.gradle/
        # Clear environment variables (belt and suspenders)
        unset ANDROID_KEYSTORE_PASSWORD
        unset ANDROID_KEY_PASSWORD
        unset ANDROID_KEY_ALIAS
        echo "‚úÖ Cleanup complete"

    - name: Generate Testing Instructions
      if: always()
      env:
        ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      run: |
        echo "# üì± Mobile App Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Configuration Status
        echo "## üîß Configuration Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.ref_name }}" == "main" ]; then
          if [ -n "$ANDROID_KEYSTORE_BASE64" ]; then
            echo "- ‚úÖ Android signing keystore configured" >> $GITHUB_STEP_SUMMARY
            echo "- ‚ÑπÔ∏è  Build type: **release** (WebView debugging disabled)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ö†Ô∏è  Android signing keystore **not configured** (building debug APKs)" >> $GITHUB_STEP_SUMMARY
          fi
        elif [ "${{ github.ref_name }}" == "staging" ]; then
          if [ -n "$ANDROID_KEYSTORE_BASE64" ]; then
            echo "- ‚úÖ Android signing keystore configured" >> $GITHUB_STEP_SUMMARY
            echo "- ‚ÑπÔ∏è  Build type: **release** (WebView debugging enabled for chrome://inspect)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ö†Ô∏è  Android signing keystore **not configured** (building debug APKs)" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "- ‚ÑπÔ∏è  Building on **${{ github.ref_name }}** branch (debug builds)" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "## ‚¨áÔ∏è Download Instructions" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ü§ñ Android Builds (${{ env.APK_TYPE }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### APK (for direct installation)" >> $GITHUB_STEP_SUMMARY
        echo "1. **Download:** Click on 'Mobile-Android-APK-${{ env.APK_TYPE }}-${{ env.SANITIZED_BRANCH_NAME }}-${{ github.run_number }}' in Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "2. **Install on Phone:**" >> $GITHUB_STEP_SUMMARY
        echo "   - Enable 'Install from Unknown Sources' in Settings > Security" >> $GITHUB_STEP_SUMMARY
        echo "   - Open the downloaded APK file" >> $GITHUB_STEP_SUMMARY
        echo "   - Tap Install" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ env.APK_TYPE }}" == "release" ]]; then
          echo "#### AAB (for Google Play Store)" >> $GITHUB_STEP_SUMMARY

          # Check if Google Play upload is configured using step output
          if [[ "${{ steps.check-google-play.outputs.configured }}" == "true" ]]; then
            echo "‚úÖ **Automatic Upload**: AAB automatically uploaded to Google Play Console (Internal Track)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**To view your uploaded build:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to [Google Play Console](https://play.google.com/console)" >> $GITHUB_STEP_SUMMARY
            echo "2. Select your app" >> $GITHUB_STEP_SUMMARY
            echo "3. Navigate to **Testing ‚Üí Internal testing**" >> $GITHUB_STEP_SUMMARY
            echo "4. Click **View release details** to see build status" >> $GITHUB_STEP_SUMMARY
            echo "5. Add testers via **Testers** tab ‚Üí Manage testers list" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üì± Testers can install via the **internal app sharing link** or Play Store (once added to testers list)" >> $GITHUB_STEP_SUMMARY
          else
            echo "1. **Download:** Click on 'Mobile-Android-AAB-${{ env.APK_TYPE }}-${{ env.SANITIZED_BRANCH_NAME }}-${{ github.run_number }}' in Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "2. **Upload to Play Console:** Go to Release ‚Üí Production ‚Üí Create new release" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üí° **Tip**: Configure \`GOOGLE_PLAY_SERVICE_ACCOUNT_JSON\` secret to enable automatic uploads" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.ref_name }}" == "staging" ]; then
            echo "‚úÖ **Staging Build** - Signed with production keystore" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üîç Chrome Remote Debugging" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "WebView debugging is **ENABLED** for this staging build!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To inspect:" >> $GITHUB_STEP_SUMMARY
            echo "1. Connect your Android device via USB" >> $GITHUB_STEP_SUMMARY
            echo "2. Enable USB debugging on the device" >> $GITHUB_STEP_SUMMARY
            echo "3. Open Chrome on your computer and go to \`chrome://inspect\`" >> $GITHUB_STEP_SUMMARY
            echo "4. Your app's WebView should appear under 'Remote Target'" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è Make sure 'WebView implementation' in Developer Options is set to **Chrome**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **Production Release** - Signed with production keystore and ready for Google Play Store" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "‚ö†Ô∏è **Debug Build** - For testing only." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.ref_name }}" == "main" ]; then
            echo "**To enable production builds:**" >> $GITHUB_STEP_SUMMARY
            echo "Add these secrets to GitHub Actions (see MOBILE_SECRETS_SETUP_GUIDE.md):" >> $GITHUB_STEP_SUMMARY
            echo "- \`ANDROID_KEYSTORE_BASE64\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ANDROID_KEYSTORE_PASSWORD\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ANDROID_KEY_PASSWORD\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ANDROID_KEY_ALIAS\`" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üì± iOS App (TestFlight)" >> $GITHUB_STEP_SUMMARY
        echo "iOS build runs in a separate job on macOS runner." >> $GITHUB_STEP_SUMMARY
        echo "Check the **build-ios** job for iOS build results." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**To view your uploaded TestFlight build:**" >> $GITHUB_STEP_SUMMARY
        echo "1. Go to [App Store Connect](https://appstoreconnect.apple.com)" >> $GITHUB_STEP_SUMMARY
        echo "2. Select your app ‚Üí **TestFlight** tab" >> $GITHUB_STEP_SUMMARY
        echo "3. View builds under **iOS Builds** section" >> $GITHUB_STEP_SUMMARY
        echo "4. Navigate to **Internal Testing** ‚Üí Select your group" >> $GITHUB_STEP_SUMMARY
        echo "5. Add testers via **App Store Connect Users** or **Testers** list" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üì± Testers receive an email invite and install via the **TestFlight app** on their iOS device" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "**Build Info:**" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- Run: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- Build Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

    - name: Security Check - Verify No Sensitive Files Before Docker Build
      run: |
        echo "üîê Running security verification before Docker build..."

        # Check for any keystore or signing files
        SENSITIVE_FILES=$(find . -type f \( -name "*.jks" -o -name "*.keystore" -o -name "*.p12" \) 2>/dev/null || true)

        if [ -n "$SENSITIVE_FILES" ]; then
          echo "‚ùå SECURITY ERROR: Found sensitive signing files that should have been cleaned up:"
          echo "$SENSITIVE_FILES"
          echo ""
          echo "These files will NOT be included in Docker (blocked by .dockerignore), but they should not exist at this point."
          echo "This indicates the cleanup step may have failed."
          exit 1
        else
          echo "‚úÖ No sensitive signing files found - security check passed"
        fi

        # Verify .dockerignore exists and contains keystore exclusions
        if [ ! -f .dockerignore ]; then
          echo "‚ö†Ô∏è  WARNING: .dockerignore not found!"
        else
          if grep -q "\.jks" .dockerignore; then
            echo "‚úÖ .dockerignore properly excludes keystore files"
          else
            echo "‚ö†Ô∏è  WARNING: .dockerignore may not exclude keystore files"
          fi
        fi

    - name: Remove conflicting packages and Install Docker
      run: |
        sudo apt-get remove -y containerd.io moby-runc runc
        sudo apt-get update
        sudo apt-get install -y docker.io

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Login to ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
      with:
        registries: ${{ secrets.REGISTRIES }}

    - name: Generate Cache Version
      id: cache-version
      run: echo "version=$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT

    - name: Log Cache Version
      run: |
        echo "Using CACHE_VERSION:"
        echo "${{ steps.cache-version.outputs.version }}"

    - name: Set IMAGE_TAG
      id: image_tag
      shell: bash
      run: |
        # Determine the branch name based on the event type
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          # For pull requests, use the base branch (target branch)
          BRANCH_NAME="${{ github.event.pull_request.base.ref }}"
        else
          # For pushes, use the ref name
          BRANCH_NAME="${{ github.ref_name }}"
        fi

        echo "BRANCH_NAME is: $BRANCH_NAME"

        # Ensure BRANCH_NAME is either 'main' or 'staging'
        if [ "$BRANCH_NAME" != "main" ] && [ "$BRANCH_NAME" != "staging" ]; then
          echo "Error: BRANCH_NAME must be 'main' or 'staging'. Got '$BRANCH_NAME'"
          exit 1
        fi

        # Construct the IMAGE_TAG
        IMAGE_TAG="${{ github.sha }}-$BRANCH_NAME"

        echo "IMAGE_TAG is: $IMAGE_TAG"

        # Set the output variable
        echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

    - name: Build, tag, and push docker image to Amazon ECR
      env:
        ECR_REPO_NAME: ${{ secrets.ECR_REPO_NAME }}
      run: |
        set -euxo pipefail
        
        # Verify required variables
        if [ -z "${ECR_REPO_NAME}" ]; then
          echo "Error: ECR_REPO_NAME must be set"
          exit 1
        fi

        REGISTRY="${{ steps.login-ecr.outputs.registry }}"
        IMAGE_TAG="${{ steps.image_tag.outputs.image_tag }}"
        
        echo "Building and pushing image: $REGISTRY/$ECR_REPO_NAME:$IMAGE_TAG"
        
        docker build \
          --build-arg CACHE_VERSION=${{ steps.cache-version.outputs.version }} \
          --build-arg REGION=${{ secrets.AWS_REGION }} \
          --build-arg DB_NAME_SECRET_NAME=${{ secrets.DB_NAME_SECRET_NAME }} \
          --build-arg DB_USER_SECRET_NAME=${{ secrets.DB_USER_SECRET_NAME }} \
          --build-arg DB_PASSWORD_SECRET_NAME=${{ secrets.DB_PASSWORD_SECRET_NAME }} \
          --build-arg DB_HOST_SECRET_NAME=${{ secrets.DB_HOST_SECRET_NAME }} \
          --build-arg DB_PORT_SECRET_NAME=${{ secrets.DB_PORT_SECRET_NAME }} \
          --build-arg MAIL_PASSWORD_SECRET_NAME=${{ secrets.MAIL_PASSWORD_SECRET_NAME }} \
          --build-arg ADDITIONAL_SECRETS=${{ secrets.ADDITIONAL_SECRETS }} \
          --build-arg MAIL_USERNAME=${{ secrets.MAIL_USERNAME }} \
          --build-arg MAIL_DEFAULT_SENDER=${{ secrets.MAIL_DEFAULT_SENDER }} \
          --build-arg ADMIN_USERS_SECRET_NAME=${{ secrets.ADMIN_USERS_SECRET_NAME }} \
          -t $REGISTRY/$ECR_REPO_NAME:$IMAGE_TAG .
        
        docker push $REGISTRY/$ECR_REPO_NAME:$IMAGE_TAG
  build-ios:
    name: Build iOS App
    runs-on: macos-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.9.0'

      - name: Cache npm dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-20.9.0-${{ hashFiles('package-lock.json', '**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-20.9.0-

      - name: Install dependencies
        run: npm ci

      - name: Install TypeScript and esbuild
        run: npm install -g typescript esbuild

      - name: Build frontend assets
        run: npm run frontend:build

      - name: Prepare Mobile Environment
        run: |
          chmod +x build-mobile.sh

          # Set environment based on branch
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "Building for production environment"
            export MOBILE_ENV=production
            ./build-mobile.sh
          elif [[ "${{ github.ref_name }}" == "staging" ]]; then
            echo "Building for staging environment"
            export MOBILE_ENV=staging
            ./build-mobile.sh
          else
            echo "Building for development environment"
            export MOBILE_ENV=local
            ./build-mobile.sh
          fi

      - name: Install Ruby gems for Xcode project manipulation
        run: |
          gem install xcodeproj

      - name: Configure iOS WebView Debugging (Staging Only)
        if: github.ref == 'refs/heads/staging'
        run: |
          echo "üîç Enabling Safari Web Inspector for staging build..."

          # Enable webview debugging in Capacitor config before sync
          if [ -f capacitor.config.json ]; then
            node -e "
              const fs = require('fs');
              const config = JSON.parse(fs.readFileSync('capacitor.config.json', 'utf8'));
              config.ios = config.ios || {};
              config.ios.webContentsDebuggingEnabled = true;
              fs.writeFileSync('capacitor.config.json', JSON.stringify(config, null, 2));
              console.log('‚úÖ Enabled webContentsDebuggingEnabled in capacitor.config.json');
            "
            echo ""
            echo "üîç Safari Web Inspector Debugging ENABLED"
            echo "   To debug:"
            echo "   1. Connect iPhone to Mac via USB"
            echo "   2. On iPhone: Settings ‚Üí Safari ‚Üí Advanced ‚Üí Web Inspector ON"
            echo "   3. On Mac: Safari ‚Üí Develop ‚Üí [Your iPhone] ‚Üí [App WebView]"
          else
            echo "‚ö†Ô∏è capacitor.config.json not found"
          fi

      - name: Initialize and Sync Capacitor iOS
        env:
          IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
          ANDROID_PACKAGE_NAME: ${{ secrets.ANDROID_PACKAGE_NAME }}
        run: |
          # Use bundle ID from secrets or default
          BUNDLE_ID="${IOS_BUNDLE_ID:-${ANDROID_PACKAGE_NAME:-com.example.app}}"
          APP_NAME="My App"

          # Initialize Capacitor if needed
          if [ ! -f capacitor.config.json ]; then
            npx cap init "$APP_NAME" "$BUNDLE_ID" --web-dir="frontend/public/static/dist"
          fi

          # Update appId in capacitor.config.json from environment variable
          if [ -n "$IOS_BUNDLE_ID" ] && [ -f capacitor.config.json ]; then
            echo "üìù Updating capacitor.config.json with bundle ID from IOS_BUNDLE_ID secret..."
            node -e "
              const fs = require('fs');
              const config = JSON.parse(fs.readFileSync('capacitor.config.json', 'utf8'));
              config.appId = process.env.IOS_BUNDLE_ID;
              fs.writeFileSync('capacitor.config.json', JSON.stringify(config, null, 2));
              console.log('‚úÖ Updated appId to: ' + process.env.IOS_BUNDLE_ID);
            "
          fi

          # Add iOS platform if not already added
          if [ ! -d ios ]; then
            npx cap add ios
          fi

          # Sync the app (this copies capacitor.config.json settings to iOS project)
          npx cap sync ios

      - name: Install CocoaPods
        run: |
          cd ios/App
          pod install

      - name: Import iOS Certificates (Main and Staging)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          if [ -n "$IOS_CERTIFICATE_BASE64" ]; then
            # Create temporary keychain
            security create-keychain -p temp_password build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p temp_password build.keychain
            security set-keychain-settings -t 3600 -u build.keychain

            # Import certificate
            echo "$IOS_CERTIFICATE_BASE64" | base64 -d > certificate.p12
            security import certificate.p12 -k build.keychain -P "$IOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
            security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k temp_password build.keychain

            # Install provisioning profile and extract UUID
            mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
            echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 -d > /tmp/build.mobileprovision

            # Extract UUID from provisioning profile
            PROFILE_UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< $(/usr/bin/security cms -D -i /tmp/build.mobileprovision))
            echo "üìã Provisioning Profile UUID: $PROFILE_UUID"

            # Copy to the correct location with UUID as filename
            cp /tmp/build.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/${PROFILE_UUID}.mobileprovision

            # Also keep a copy at build.mobileprovision for the check
            cp /tmp/build.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/build.mobileprovision

            # Export UUID for later steps
            echo "PROVISIONING_PROFILE_UUID=$PROFILE_UUID" >> $GITHUB_ENV

            echo "‚úÖ iOS certificates and provisioning profile installed"
          else
            echo "‚ö†Ô∏è Skipping certificate import - IOS_CERTIFICATE_BASE64 not set"
          fi

      - name: Configure iOS Build Settings
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
        env:
          VERSION_CODE: ${{ github.run_number }}
          ENABLE_WEBVIEW_DEBUG: ${{ github.ref == 'refs/heads/staging' && 'true' || 'false' }}
        run: |
          echo "üì± Configuring iOS build settings..."
          echo "‚ÑπÔ∏è  Branch: ${{ github.ref_name }}"
          echo "‚ÑπÔ∏è  Build number: $VERSION_CODE"

          # Update build number in Info.plist
          cd ios/App/App
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $VERSION_CODE" Info.plist
          echo "‚úÖ Set CFBundleVersion to $VERSION_CODE"

          # For staging, enable Safari Web Inspector debugging
          if [ "$ENABLE_WEBVIEW_DEBUG" == "true" ]; then
            echo "‚ÑπÔ∏è  Staging build: Enabling Safari Web Inspector for debugging"

            # Check if capacitor.config.json exists and update it
            if [ -f ../../../capacitor.config.json ]; then
              # Enable webview debugging in Capacitor config
              node -e "
                const fs = require('fs');
                const config = JSON.parse(fs.readFileSync('../../../capacitor.config.json', 'utf8'));
                config.ios = config.ios || {};
                config.ios.webContentsDebuggingEnabled = true;
                fs.writeFileSync('../../../capacitor.config.json', JSON.stringify(config, null, 2));
                console.log('‚úÖ Enabled webContentsDebuggingEnabled in capacitor.config.json');
              "
            fi

            echo ""
            echo "üîç Safari Web Inspector Debugging ENABLED"
            echo "   To debug:"
            echo "   1. Connect iPhone to Mac via USB"
            echo "   2. On iPhone: Settings ‚Üí Safari ‚Üí Advanced ‚Üí Web Inspector ON"
            echo "   3. On Mac: Safari ‚Üí Develop ‚Üí [Your iPhone] ‚Üí [App WebView]"
          else
            echo "‚ÑπÔ∏è  Production build: Safari Web Inspector disabled"
          fi

      - name: Build iOS Archive (Main and Staging)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          VERSION_CODE: ${{ github.run_number }}
          IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
          ANDROID_PACKAGE_NAME: ${{ secrets.ANDROID_PACKAGE_NAME }}
        run: |
          if [ -n "$IOS_CERTIFICATE_BASE64" ] && [ -f ~/Library/MobileDevice/Provisioning\ Profiles/build.mobileprovision ]; then
            cd ios/App

            echo "üî® Building iOS archive..."
            echo "‚ÑπÔ∏è  Build number: $VERSION_CODE"
            echo "‚ÑπÔ∏è  Team ID: $APPLE_TEAM_ID"
            echo "‚ÑπÔ∏è  Provisioning Profile UUID: $PROVISIONING_PROFILE_UUID"

            # Use Ruby to modify project.pbxproj for manual signing
            echo "üìù Configuring manual code signing in project..."

            ruby -e "
            require 'xcodeproj'
            project = Xcodeproj::Project.open('App.xcodeproj')
            team_id = ENV['APPLE_TEAM_ID']
            profile_uuid = ENV['PROVISIONING_PROFILE_UUID']
            project.targets.each do |target|
              if target.name == 'App'
                target.build_configurations.each do |config|
                  config.build_settings['CODE_SIGN_STYLE'] = 'Manual'
                  config.build_settings['DEVELOPMENT_TEAM'] = team_id
                  config.build_settings['PROVISIONING_PROFILE_SPECIFIER'] = profile_uuid
                  config.build_settings['CODE_SIGN_IDENTITY[sdk=iphoneos*]'] = 'iPhone Distribution'
                  puts \"Configured #{config.name} for target #{target.name}\"
                end
              end
            end
            project.save
            puts 'Project saved with manual signing configuration'
            "

            # Create ExportOptions.plist for archive export
            /usr/libexec/PlistBuddy -c "Clear dict" ExportOptions.plist 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Add :method string app-store" ExportOptions.plist
            /usr/libexec/PlistBuddy -c "Add :teamID string $APPLE_TEAM_ID" ExportOptions.plist
            /usr/libexec/PlistBuddy -c "Add :signingStyle string manual" ExportOptions.plist
            /usr/libexec/PlistBuddy -c "Add :provisioningProfiles dict" ExportOptions.plist
            # Get bundle ID from secrets or use default
            BUNDLE_ID="${IOS_BUNDLE_ID:-${ANDROID_PACKAGE_NAME:-com.example.app}}"
            /usr/libexec/PlistBuddy -c "Add :provisioningProfiles:$BUNDLE_ID string $PROVISIONING_PROFILE_UUID" ExportOptions.plist
            /usr/libexec/PlistBuddy -c "Add :uploadSymbols bool true" ExportOptions.plist
            /usr/libexec/PlistBuddy -c "Add :compileBitcode bool false" ExportOptions.plist

            echo "üìù Created ExportOptions.plist"
            cat ExportOptions.plist

            # Build archive
            xcodebuild -workspace App.xcworkspace \
              -scheme App \
              -configuration Release \
              -destination "generic/platform=iOS" \
              -archivePath $PWD/build/App.xcarchive \
              CURRENT_PROJECT_VERSION=$VERSION_CODE \
              archive

            echo "‚úÖ iOS archive created for ${{ github.ref_name }} branch (build $VERSION_CODE)"
          else
            echo "‚ö†Ô∏è Skipping iOS archive - certificates not configured"
          fi

      - name: Export IPA (Main and Staging)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        run: |
          if [ -n "$IOS_CERTIFICATE_BASE64" ] && [ -d ios/App/build/App.xcarchive ]; then
            cd ios/App

            # ExportOptions.plist was already created in the build step with provisioning profile
            echo "üìù Using ExportOptions.plist created in build step"
            cat ExportOptions.plist

            xcodebuild -exportArchive \
              -archivePath $PWD/build/App.xcarchive \
              -exportPath $PWD/build \
              -exportOptionsPlist ExportOptions.plist

            echo "‚úÖ IPA exported for ${{ github.ref_name }} branch"
            ls -lh build/*.ipa
          else
            echo "‚ö†Ô∏è Skipping IPA export - archive not available"
          fi

      - name: Upload to TestFlight (Main and Staging)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
          VERSION_CODE: ${{ github.run_number }}
        run: |
          # Find the IPA file
          IPA_FILE=$(find ios/App/build -name "*.ipa" -type f | head -1)

          if [ -z "$IPA_FILE" ]; then
            echo "‚ö†Ô∏è No IPA file found in ios/App/build"
            exit 0
          fi

          echo "Found IPA: $IPA_FILE"

          # Determine build type and release name
          if [ "${{ github.ref_name }}" == "staging" ]; then
            RELEASE_NAME="[STAGING] Build $VERSION_CODE"
            BUILD_TYPE="staging"
            echo "üì¶ Staging build - WebView debugging ENABLED"
          else
            RELEASE_NAME="Build $VERSION_CODE"
            BUILD_TYPE="production"
            echo "üì¶ Production build - WebView debugging DISABLED"
          fi

          echo "‚ÑπÔ∏è  Release name: $RELEASE_NAME"
          echo "‚ÑπÔ∏è  Build number: $VERSION_CODE"

          if [ -n "$IOS_CERTIFICATE_BASE64" ] && [ -n "$APP_STORE_CONNECT_API_KEY_ID" ] && [ -n "$APP_STORE_CONNECT_API_KEY_BASE64" ]; then
            echo "üì§ Uploading to TestFlight (Internal Testing)..."

            # Decode the API key
            mkdir -p ~/.appstoreconnect/private_keys
            echo "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 -d > ~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8

            # Upload using xcrun altool with API key authentication (recommended method)
            xcrun altool --upload-app \
              --type ios \
              --file "$IPA_FILE" \
              --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
              --apiIssuer "$APP_STORE_CONNECT_API_ISSUER_ID"

            echo ""
            echo "‚úÖ Uploaded to TestFlight (Internal Testing) from ${{ github.ref_name }} branch"
            echo ""
            echo "üì± Build Details:"
            echo "   - Build Number: $VERSION_CODE"
            echo "   - Build Type: $BUILD_TYPE"
            if [ "$BUILD_TYPE" == "staging" ]; then
              echo "   - Debugging: Safari Web Inspector ENABLED"
              echo ""
              echo "üîç To view console logs on staging build:"
              echo "   1. Connect iPhone to Mac via USB"
              echo "   2. On iPhone: Settings ‚Üí Safari ‚Üí Advanced ‚Üí Web Inspector ON"
              echo "   3. On Mac: Safari ‚Üí Develop ‚Üí [Your iPhone] ‚Üí [App WebView]"
            else
              echo "   - Debugging: Disabled (production)"
            fi
            echo ""
            echo "‚è≥ The build will be available in TestFlight after Apple processes it (usually 10-30 minutes)"
            echo "   Internal testers will be notified automatically once the build is ready"

            # Cleanup API key
            rm -f ~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8

            # Save build info for summary
            echo "IOS_BUILD_TYPE=$BUILD_TYPE" >> $GITHUB_ENV
            echo "IOS_RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è Skipping TestFlight upload - missing required secrets"
            echo ""
            echo "Required secrets for TestFlight upload:"
            echo "- APP_STORE_CONNECT_API_KEY_ID"
            echo "- APP_STORE_CONNECT_API_ISSUER_ID"
            echo "- APP_STORE_CONNECT_API_KEY_BASE64"
            echo ""
            echo "To set up App Store Connect API key:"
            echo "1. Go to App Store Connect ‚Üí Users and Access ‚Üí Keys"
            echo "2. Create a new API key with 'App Manager' role"
            echo "3. Add the Key ID, Issuer ID, and base64-encoded .p8 file as GitHub secrets"
          fi

      - name: Sanitize branch name for artifacts
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          SANITIZED_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[\/:\\<>|*?"]/-/g')
          echo "SANITIZED_BRANCH_NAME=$SANITIZED_BRANCH" >> $GITHUB_ENV

      - name: Check if IPA exists
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
        id: check_ipa
        run: |
          if [ -f ios/App/build/*.ipa ]; then
            echo "ipa_exists=true" >> $GITHUB_OUTPUT
          else
            echo "ipa_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload iOS IPA artifact
        if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging') && steps.check_ipa.outputs.ipa_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: Mobile-iOS-IPA-${{ env.SANITIZED_BRANCH_NAME }}-${{ github.run_number }}
          path: ios/App/build/*.ipa
          retention-days: 30
          if-no-files-found: warn

      - name: Build iOS for Development (No Certs)
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ] && [ "${{ github.ref }}" != "refs/heads/staging" ] || [ -z "$IOS_CERTIFICATE_BASE64" ]; then
            echo "‚ö†Ô∏è iOS production build skipped - missing certificates or not on main/staging branch"
            echo ""
            echo "To enable iOS builds:"
            echo "1. Add iOS signing certificates to GitHub Secrets"
            echo "2. Push to main or staging branch"
            echo ""
            echo "Required secrets:"
            echo "- IOS_CERTIFICATE_BASE64"
            echo "- IOS_CERTIFICATE_PASSWORD"
            echo "- IOS_PROVISIONING_PROFILE_BASE64"
            echo "- APPLE_TEAM_ID"
            echo "- APPLE_ID (optional, for TestFlight upload)"
            echo "- APPLE_APP_SPECIFIC_PASSWORD (optional, for TestFlight upload)"
          fi

      - name: Generate iOS Build Summary
        if: always()
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          VERSION_CODE: ${{ github.run_number }}
        run: |
          echo "# üì± iOS Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Configuration Status
          echo "## üîß Configuration Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.ref_name }}" == "main" ] || [ "${{ github.ref_name }}" == "staging" ]; then
            if [ -n "$IOS_CERTIFICATE_BASE64" ]; then
              echo "- ‚úÖ iOS signing certificates configured" >> $GITHUB_STEP_SUMMARY
              if [ -n "$APP_STORE_CONNECT_API_KEY_ID" ]; then
                echo "- ‚úÖ App Store Connect API key configured for TestFlight upload" >> $GITHUB_STEP_SUMMARY
              else
                echo "- ‚ö†Ô∏è  App Store Connect API key not configured (TestFlight upload disabled)" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "- ‚ö†Ô∏è  iOS signing certificates **not configured**" >> $GITHUB_STEP_SUMMARY
            fi

            # Show build type info
            if [ "${{ github.ref_name }}" == "staging" ]; then
              echo "- ‚ÑπÔ∏è  Build type: **STAGING** (Safari Web Inspector ENABLED)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ‚ÑπÔ∏è  Build type: **PRODUCTION** (Safari Web Inspector disabled)" >> $GITHUB_STEP_SUMMARY
            fi
            echo "- ‚ÑπÔ∏è  Build number: **$VERSION_CODE**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ÑπÔ∏è  Building on **${{ github.ref_name }}** branch (signed builds only on main/staging)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == "refs/heads/staging" ]] && [[ -n "$IOS_CERTIFICATE_BASE64" ]]; then
            echo "## ‚úÖ Signed iOS Build (${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Check if IPA was actually created
            if [ "${{ steps.check_ipa.outputs.ipa_exists }}" == "true" ]; then
              echo "- **IPA Created**: ‚úÖ Mobile-iOS-IPA-${{ env.SANITIZED_BRANCH_NAME }}-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
              echo "- **Build Number**: $VERSION_CODE" >> $GITHUB_STEP_SUMMARY
              if [ -n "$APP_STORE_CONNECT_API_KEY_ID" ]; then
                if [ "${{ github.ref_name }}" == "staging" ]; then
                  echo "- **TestFlight Upload**: ‚úÖ Uploaded as **[STAGING] Build $VERSION_CODE**" >> $GITHUB_STEP_SUMMARY
                else
                  echo "- **TestFlight Upload**: ‚úÖ Uploaded as **Build $VERSION_CODE**" >> $GITHUB_STEP_SUMMARY
                fi
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "üì± The build will appear in TestFlight after Apple processes it (10-30 min)" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "**To view your uploaded build:**" >> $GITHUB_STEP_SUMMARY
                echo "1. Go to [App Store Connect](https://appstoreconnect.apple.com)" >> $GITHUB_STEP_SUMMARY
                echo "2. Select your app ‚Üí **TestFlight** tab" >> $GITHUB_STEP_SUMMARY
                echo "3. View builds under **iOS Builds** section" >> $GITHUB_STEP_SUMMARY
                echo "4. Navigate to **Internal Testing** ‚Üí Select your group" >> $GITHUB_STEP_SUMMARY
                echo "5. Add testers via **App Store Connect Users** or **Testers** list" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "üì± Testers receive an email invite and install via the **TestFlight app**" >> $GITHUB_STEP_SUMMARY
              else
                echo "- **TestFlight Upload**: Skipped (no App Store Connect API key configured)" >> $GITHUB_STEP_SUMMARY
              fi
              echo "" >> $GITHUB_STEP_SUMMARY

              # Debugging instructions for staging
              if [ "${{ github.ref_name }}" == "staging" ]; then
                echo "### üîç Safari Web Inspector Debugging" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "WebView debugging is **ENABLED** for this staging build!" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "To view console logs:" >> $GITHUB_STEP_SUMMARY
                echo "1. Connect your iPhone to Mac via USB" >> $GITHUB_STEP_SUMMARY
                echo "2. On iPhone: Settings ‚Üí Safari ‚Üí Advanced ‚Üí Web Inspector ON" >> $GITHUB_STEP_SUMMARY
                echo "3. On Mac: Safari ‚Üí Develop ‚Üí [Your iPhone] ‚Üí [App WebView]" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi

              echo "üì¶ Download the IPA from Artifacts below or check TestFlight." >> $GITHUB_STEP_SUMMARY
            else
              echo "- **IPA Created**: ‚ö†Ô∏è  Build may have failed (check logs above)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## ‚ö†Ô∏è iOS Signed Build Skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ github.ref_name }}" != "main" ] && [ "${{ github.ref_name }}" != "staging" ]; then
              echo "**Reason**: Not on main or staging branch (currently on ${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Signed iOS builds only run on the **main** and **staging** branches." >> $GITHUB_STEP_SUMMARY
            else
              echo "**Reason**: Missing iOS signing certificates" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**To enable iOS signed builds:**" >> $GITHUB_STEP_SUMMARY
              echo "Add these secrets to GitHub Actions (see MOBILE_SECRETS_SETUP_GUIDE.md):" >> $GITHUB_STEP_SUMMARY
              echo "- \`IOS_CERTIFICATE_BASE64\` (required)" >> $GITHUB_STEP_SUMMARY
              echo "- \`IOS_CERTIFICATE_PASSWORD\` (required)" >> $GITHUB_STEP_SUMMARY
              echo "- \`IOS_PROVISIONING_PROFILE_BASE64\` (required)" >> $GITHUB_STEP_SUMMARY
              echo "- \`APPLE_TEAM_ID\` (required)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**For TestFlight upload (optional):**" >> $GITHUB_STEP_SUMMARY
              echo "- \`APP_STORE_CONNECT_API_KEY_ID\`" >> $GITHUB_STEP_SUMMARY
              echo "- \`APP_STORE_CONNECT_API_ISSUER_ID\`" >> $GITHUB_STEP_SUMMARY
              echo "- \`APP_STORE_CONNECT_API_KEY_BASE64\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Build Info:**" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Run: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup secrets and keychain
        if: always()
        run: |
          rm -f certificate.p12
          security delete-keychain build.keychain || true
